<!DOCTYPE html>
<html lang="ar">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Ø®Ø±ÙŠØ·Ø© Ù…Ø±Ø§ÙÙ‚ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ§Ù„Ø­ Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© - Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</title>
<link rel="icon" type="image/png" href="logo.png" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<script>
Â  Â  // âš ï¸ Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡Ø§
Â  Â  window.onload = async function() {
Â  Â  Â  Â  const userProfile = await protectPage();

Â  Â  Â  Â  if (!userProfile) return; // protectPage Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹

Â  Â  Â  Â  // âš ï¸ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
Â  Â  Â  Â  const allowedRoles = ["admin", "user", "guest"];
Â  Â  Â  Â  if (!allowedRoles.includes(userProfile.role)) {
Â  Â  Â  Â  Â  Â  alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
Â  Â  Â  Â  Â  Â  logout(); // Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ Supabase
Â  Â  Â  Â  await recordVisit(userProfile.role, window.location.pathname.split('/').pop());

Â  Â  Â  Â  // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ù†Ø¨Ø¯Ø£ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)
Â  Â  Â  Â  initMapLogic();
Â  Â  };

Â  Â  // ğŸ’¡ Ù…Ù‡Ù…: Ø¯Ø§Ù„Ø© ÙˆÙ‡Ù…ÙŠØ© Ù„Ù…Ù†Ø¹ ØªÙ†ÙÙŠØ° Ø¨Ø§Ù‚ÙŠ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
Â  Â  function initMapLogic(){
Â  Â  Â  Â  // Ù‡Ù†Ø§ Ø³ÙŠØ¨Ø¯Ø£ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
Â  Â  Â  Â  // (ÙˆÙ‡Ùˆ Ù…Ø§ ØªÙ… Ù†Ù‚Ù„Ù‡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯)
Â  Â  }

</script>

<style>
/* -------------------------------------------------
Â  Â CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù‡Ù†Ø§ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù…Ø§ Ø¹Ø¯Ø§ Ø³Ù‡Ù… Ø§Ù„Ø´Ù…Ø§Ù„)
Â  Â ------------------------------------------------- */
Â  :root{
Â  Â  --accent:#228B22;
Â  Â  --green:#32CD32;
Â  Â  --danger:#b22222;
Â  Â  --sidebar-width:300px;
Â  Â  --header-height:70px;
Â  Â  --footer-height:70px;
Â  }
Â  *{box-sizing:border-box}
Â  body{
Â  Â  margin:0;
Â  Â  padding:0;
Â  Â  direction:rtl;
Â  Â  font-family:"Cairo",sans-serif;
Â  Â  background:#ffffff;
Â  Â  -webkit-font-smoothing:antialiased;
Â  Â  -moz-osx-font-smoothing:grayscale;
Â  Â  overflow-x:hidden;
Â  }

Â  /* Header */
Â  header{
Â  Â  position:fixed;
Â  Â  top:0; left:0; right:0;
Â  Â  height:var(--header-height);
Â  Â  display:flex;
Â  Â  align-items:center;
Â  Â  justify-content:center;
Â  Â  gap:12px;
Â  Â  background:linear-gradient(90deg,#00b09b,#96c93d);
Â  Â  color:#fff;
Â  Â  padding:10px;
Â  Â  z-index:2200;
Â  Â  box-shadow:0 2px 6px rgba(0,0,0,0.12);
Â  }
Â  header img.logo{
Â  Â  height:48px;
Â  Â  margin-inline-start:6px; /* logo on the right (rtl) */
Â  }
Â  header h1{
Â  Â  margin:0;
Â  Â  font-size:18px;
Â  Â  font-weight:700;
Â  Â  text-align:center;
Â  }

Â  /* Map centered area */
Â  #map{
Â  Â  height:80vh;
Â  Â  width:100%;
Â  Â  margin-top:var(--header-height);
Â  Â  margin-bottom:var(--footer-height);
Â  Â  border-radius:8px;
Â  Â  box-shadow:0 2px 6px rgba(0,0,0,0.12);
Â  }

Â  /* Sidebar - its bottom aligns with the map bottom: height = 80vh and top = header height */
Â  #sidebar{
Â  Â  position:fixed;
Â  Â  top:var(--header-height);
Â  Â  right:0;
Â  Â  width:var(--sidebar-width);
Â  Â  max-width:92%;
Â  Â  height:80vh; /* same as map height */
Â  Â  background:#fff;
Â  Â  border-left:2px solid #32CD32;
Â  Â  box-shadow:-2px 0 8px rgba(0,0,0,0.12);
Â  Â  overflow-y:auto;
Â  Â  z-index:2000;
Â  Â  padding:14px 12px 18px 12px;
Â  Â  border-radius:0 8px 8px 0;
Â  Â  transition:transform .28s ease, background .2s ease;
Â  }
Â  #sidebar.hidden{ transform: translateX(100%); }

Â  /* Sidebar sections */
Â  .sidebar-section{ margin-bottom:12px; padding-top:8px; }
Â  .sidebar-section h3{
Â  Â  margin:0 0 8px 0;
Â  Â  font-size:15px;
Â  Â  color:var(--accent);
Â  Â  font-weight:700;
Â  }
Â  /* in dark mode heads become white - controlled by .dark on sidebar */
Â  #sidebar.dark .sidebar-section h3{ color:#fff; }

Â  /* controls buttons */
Â  .controls{ display:flex; flex-direction:column; gap:8px; }
Â  .controls button{
Â  Â  border:none;
Â  Â  padding:10px;
Â  Â  border-radius:8px;
Â  Â  font-weight:700;
Â  Â  cursor:pointer;
Â  Â  box-shadow:0 1px 3px rgba(0,0,0,0.1);
Â  }
Â  .controls .show{ background:var(--green); color:#000; }
Â  .controls .hide{ background:var(--danger); color:#fff; }
Â  .controls .reset{ background: #f0f9f0; color:#000; border:1px solid #cfe9cf; }

Â  /* layer groups & items */
Â  .layer-group{ margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px; }
Â  .layer-group h4{
Â  Â  margin:6px 0;
Â  Â  font-size:14px;
Â  Â  color:var(--accent);
Â  Â  cursor:pointer;
Â  Â  user-select:none;
Â  }
Â  .layer-group.collapsed > .group-items{ display:none; }
Â  .group-items{ padding-top:6px; display:block; }
Â  .layer-item{
Â  Â  background: rgba(245, 245, 245, 0.7); /* Ø§Ù„Ø´ÙØ§ÙÙŠØ© 70% */
Â  Â  color:#000; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ø³ÙˆØ¯ */
Â  Â  padding:8px 10px;
Â  Â  border-radius:6px;
Â  Â  margin-bottom:8px;
Â  Â  cursor:pointer;
Â  Â  transition: background .12s, transform .06s;
Â  Â  font-size:14px;
}

.layer-item:hover{Â 
Â  Â  background: rgba(232, 255, 232, 0.9); /* Ø£Ø®Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
Â  Â  transform: translateY(-1px);Â 
}

Â  /* Footer */
footer {
Â  Â  position: fixed;
Â  Â  bottom: 0; left: 0; right: 0;
Â  Â  background:linear-gradient(90deg,#00b09b,#96c93d);
Â  Â  color: #fff;
Â  Â  display: flex;
Â  Â  flex-direction: column; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø£Ø¹Ù…Ø¯Ø© */
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  text-align: center;
Â  Â  font-weight: 700;
Â  Â  padding: 6px 0;
Â  Â  z-index: 2000;
}

footer .line2 {
Â  Â  font-weight: 600;
Â  Â  font-size: 13px;
Â  Â  margin-top: 2px;
}


/* ğŸ“ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© */
.top-buttons {
Â  position: fixed;
Â  top: calc(var(--header-height) + 10px);
Â  right: 10px;
Â  z-index: 2050;
Â  display: flex;
Â  gap: 10px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±ÙŠÙ† */
}

/* Ø²Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
#toggleSidebar {
Â  background: linear-gradient(90deg, #00b09b, #96c93d);
Â  color: #fff;
Â  border: none;
Â  padding: 12px 16px;
Â  border-radius: 10px;
Â  font-weight: 800;
Â  font-size: 18px;
Â  cursor: pointer;
Â  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  transition: transform 0.2s, opacity 0.2s;
}

#toggleSidebar:hover {
Â  transform: scale(1.05);
Â  opacity: 0.9;
}

/* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
#printMapBtn {
Â  background: linear-gradient(90deg, #96c93d, #00b09b);
Â  color: #fff;
Â  border: none;
Â  border-radius: 10px;
Â  font-size: 20px;
Â  padding: 12px 16px;
Â  cursor: pointer;
Â  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  transition: transform 0.2s, opacity 0.2s;
}

#printMapBtn:hover {
Â  transform: scale(1.05);
Â  opacity: 0.9;
}
/* ğŸ“Œ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© */
#homeBtn, #logoutBtn {
Â  background: linear-gradient(90deg, #00b09b, #96c93d); /* Ù†ÙØ³ Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
Â  color: #fff;
Â  border: none;
Â  padding: 12px 16px;
Â  border-radius: 10px;
Â  font-weight: 800;
Â  font-size: 18px;
Â  cursor: pointer;
Â  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  transition: transform 0.2s, opacity 0.2s;
}

#homeBtn:hover, #logoutBtn:hover {
Â  transform: scale(1.05);
Â  opacity: 0.9;
}

/* ğŸ¯ Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
Â  .leaflet-control-zoom {
Â  Â  display: none !important;
Â  }
}

Â Â 
/* ğŸ“„ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© â€” Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±ÙŠÙ† */
@media print {
Â  .top-buttons { display: none; }
Â  header, footer {
Â  Â  -webkit-print-color-adjust: exact;
Â  Â  print-color-adjust: exact;
Â  }
}

/* ğŸ“± ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§ØªÙ: Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
@media (max-width: 600px) {
Â  #printMapBtn {
Â  Â  left: 50%;
Â  Â  transform: translateX(-50%);
Â  Â  top: calc(var(--header-height) + 8px);
Â  }
}

/* ğŸ–¨ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
Â  /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
Â  #toggleSidebar,
Â  #printMapBtn {
Â  Â  display: none !important;
Â  }

Â  /* Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØºØ·ÙŠ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
Â  #map {
Â  Â  height: 80vh !important;
Â  }

Â  /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
Â  header,
Â  footer {
Â  Â  -webkit-print-color-adjust: exact !important;
Â  Â  print-color-adjust: exact !important;
Â  Â  color-adjust: exact !important;
Â  }
}


Â  /* Loader overlay fullscreen */
Â  #loaderOverlay{
Â  Â  position:fixed;
Â  Â  inset:0;
Â  Â  display:flex;
Â  Â  align-items:center;
Â  Â  justify-content:center;
Â  Â  flex-direction:column;
Â  Â  background: rgba(0,0,0,0.45);
Â  Â  z-index:3000;
Â  }
Â  #loaderBox{
Â  Â  background: rgba(255,255,255,0.95);
Â  Â  padding:22px;
Â  Â  border-radius:12px;
Â  Â  display:flex;
Â  Â  align-items:center;
Â  Â  gap:14px;
Â  Â  box-shadow:0 6px 30px rgba(0,0,0,0.25);
Â  }
Â  #loaderBox img{ height:64px; width:auto; display:block; }
Â  .spinner{
Â  Â  width:44px; height:44px;
Â  Â  border-radius:50%;
Â  Â  border:6px solid rgba(0,0,0,0.08);
Â  Â  border-top-color:var(--accent);
Â  Â  animation:spin 1s linear infinite;
Â  }
Â  @keyframes spin{ to{ transform:rotate(360deg); } }

Â  /* Dark mode on sidebar: change bg but keep item text black (as requested) */
Â  #sidebar.dark{ background:#111; }
Â  #sidebar.dark .layer-item{ background:#222; color:#000; } /* dark bg but text black */

Â  /* Responsive */
Â  @media (max-width:900px){
Â  Â  :root{ --sidebar-width:75vw; }
Â  Â  #sidebar{ width:75vw; left: auto; right:0; }
Â  Â  #toggleSidebar{ right:8px; top: calc(var(--header-height)+8px); }
Â  Â  header img.logo{ height:44px; }
Â  Â  header h1{ font-size:16px; }
Â  }
Â  /* Ø¶ÙŠÙ‚ Ø£ÙƒØ«Ø± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width:600px){
Â  :root { --sidebar-width:60vw; } /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ */
Â  #sidebar{ width: var(--sidebar-width); }
}

Â  @media (max-width:480px){
Â  Â  #map{ height:70vh; }
Â  Â  #sidebar{ height:70vh; top:var(--header-height); }
Â  Â  .floating-buttons button{ min-width:34px; height:34px; font-size:15px; }
Â  }
/* ğŸ”¹ North Arrow Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
#map #northArrow {
Â  position: absolute;
Â  bottom: 20px;
Â  left: 20px;
Â  width: 60px;
Â  height: 60px;
Â  background: rgba(255, 255, 255, 0.7);
Â  border-radius: 50%;
Â  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  z-index: 1000;
Â  cursor: pointer; /* âœ… Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡ */
Â  transition: transform 0.5s ease;
}

#map #northArrow::after {
Â  content: "";
Â  display: block;
Â  width: 40px;
Â  height: 40px;
Â  /* ğŸ”‘ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØµÙˆØ±Ø© ÙÙŠ Ù…Ø¬Ù„Ø¯ map_images */
Â  background: url('assets/map_images/north.png') no-repeat center/contain;
}

/* ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
body.dark-mode #map #northArrow {
Â  background: rgba(0, 0, 0, 0.6);
Â  box-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
}

/* ğŸ”¸ ÙÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
@media (max-width: 768px) {
Â  #map #northArrow {
Â  Â  bottom: 90px; /* Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ÙÙˆØªØ± */
Â  Â  left: 15px;
Â  }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header-buttons {
Â  position: absolute;
Â  left: 20px; /* Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ (rtl) */
Â  top: 15px;
Â  display: flex;
Â  gap: 10px;
Â  z-index: 2300;
}

/* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙ‚Ø· */
@media (max-width: 600px) {
Â  .header-buttons {
Â  Â  position: relative;
Â  Â  top: 4px;
Â  Â  left: auto;
Â  Â  justify-content: center;
Â  Â  margin-top: 4px;
Â  }
Â  #homeBtn, #logoutBtn {
Â  Â  width: 40px;
Â  Â  height: 40px;
Â  Â  padding: 0;
Â  Â  font-size: 0; /* Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ */
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  }
Â  #homeBtn::before {
Â  Â  content: "ğŸ ";
Â  Â  font-size: 20px;
Â  }
Â  #logoutBtn::before {
Â  Â  content: "ğŸšª";
Â  Â  font-size: 20px;
Â  }
}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
Â  .header-buttons { display: none !important; }
}

</style>
</head>
<body>

Â  Â  <div id="loaderOverlay">
Â  Â  <div id="loaderBox" role="status" aria-live="polite">
Â  Â  Â  <img src="logo.png" alt="Logo">
Â  Â  Â  <div>
Â  Â  Â  Â  <div class="spinner" aria-hidden="true"></div>
Â  Â  Â  Â  <div style="margin-top:8px;font-weight:700;color:#222;text-align:right">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª...</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â <header id="header">
Â  <img src="logo.png" class="logo" alt="Ø´Ø¹Ø§Ø±">
Â  <h1>Ø®Ø±ÙŠØ·Ø© Ù…Ø±Ø§ÙÙ‚ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ§Ù„Ø­ Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©<br> Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h1>

Â  Â  <div class="header-buttons">
Â  Â  <button id="homeBtn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
Â  Â  <button id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
Â  </div>
</header>

Â <div class="top-buttons">
Â  <button id="toggleSidebar" aria-controls="sidebar" aria-expanded="false">â˜° Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</button>
Â  <button id="printMapBtn" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ–¨ï¸</button>
</div>

Â  Â  <aside id="sidebar" class="hidden" aria-hidden="true">
Â  Â Â 
Â  Â <div style="height:28px;"></div>


Â  Â  Â  Â  <div class="sidebar-section" style="padding-top:40px;">
Â  Â  Â  <h3>Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
Â  Â  Â  <div style="padding:6px 2px;"><label><input type="radio" name="basemap" value="osm" checked> ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ø±Ù‚</label></div>
Â  Â  Â  <div style="padding:6px 2px;"><label><input type="radio" name="basemap" value="satellite"> ğŸ›°ï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</label></div>
Â  Â  Â  <div style="padding:6px 2px;"><label><input type="radio" name="basemap" value="dark"> ğŸŒ‘ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡</label></div>
Â  Â  </div>

Â  Â  Â  Â  <div class="sidebar-section">
Â  Â  Â  <h3>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h3>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <button id="showAll" class="show">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</button>
Â  Â  Â  Â  <button id="hideAll" class="hide">Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</button>
Â  Â  Â  Â  <button id="resetMap" class="reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="sidebar-section">
Â  Â  Â  <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h3>
Â  Â  Â  <div id="layerGroups" aria-live="polite"></div>
Â  Â  </div>
Â  </aside>

Â  Â  <div id="map" role="application" aria-label="Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚">
Â  Â  <div id="northArrow" title="Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø´Ù…Ø§Ù„"></div>
Â  </div>

Â  Â  <footer>
Â  Â  Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù‡Ø§Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ - Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
Â  Â  <span class="line2">Designed By Eng. Ahmed Labib </span>
Â  </footer>

<script>
Â  Â  // -------------------------------------------------
Â  Â  // ÙˆØ¶Ø¹ ÙƒÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© initMapLogic
Â  Â  // -------------------------------------------------
Â  Â  initMapLogic = function() {

Â  Â  Â  Â  /* -----------------------
Â  Â  Â  Â  Â  Â Base maps and Map init
Â  Â  Â  Â  Â  Â ----------------------- */
Â  Â  Â  Â  const baseMaps = {
Â  Â  Â  Â  Â  Â  osm: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:'Â© OpenStreetMap contributors'}),
Â  Â  Â  Â  Â  Â  satellite: L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19}),
Â  Â  Â  Â  Â  Â  dark: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19})
Â  Â  Â  Â  };

Â  Â  Â  Â  const map = L.map('map', {
Â  Â  Â  Â  Â  Â  center:[25.687,30.841],
Â  Â  Â  Â  Â  Â  zoom:16,
Â  Â  Â  Â  Â  Â  layers:[baseMaps.osm],
Â  Â  Â  Â  Â  Â  zoomControl:true
Â  Â  Â  Â  });

Â  Â  Â  Â  /* Toggle header/sidebar dark class when dark basemap chosen */
Â  Â  Â  Â  function setDarkMode(isDark){
Â  Â  Â  Â  Â  Â  const sidebar=document.getElementById('sidebar');
Â  Â  Â  Â  Â  Â  const header=document.getElementById('header');
Â  Â  Â  Â  Â  Â  sidebar.classList.toggle('dark', isDark);
Â  Â  Â  Â  Â  Â  header.classList.toggle('dark', isDark);
Â  Â  Â  Â  }
Â  Â  Â  Â  document.querySelectorAll('input[name="basemap"]').forEach(radio => {
Â  Â  Â  Â  Â  Â  radio.addEventListener("change", e => {
Â  Â  Â  Â  Â  Â  Â  Â  // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
Â  Â  Â  Â  Â  Â  Â  Â  map.eachLayer(l => { if(l instanceof L.TileLayer) map.removeLayer(l); });
Â  Â  Â  Â  Â  Â  Â  Â  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer(baseMaps[e.target.value]);

Â  Â  Â  Â  Â  Â  Â  Â  // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„
Â  Â  Â  Â  Â  Â  Â  Â  setDarkMode(e.target.value === "dark");

Â  Â  Â  Â  Â  Â  Â  Â  // Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
Â  Â  Â  Â  Â  Â  Â  Â  if(allLayers["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢"]){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(e.target.value === "satellite"){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(allLayers["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢"]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer(allLayers["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢"]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ù†Øµ Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡
Â  Â  Â  Â  const basemapLabels = document.querySelectorAll('input[name="basemap"]');

Â  Â  Â  Â  basemapLabels.forEach(radio => {
Â  Â  Â  Â  Â  Â  radio.addEventListener('change', e => {
Â  Â  Â  Â  Â  Â  Â  Â  basemapLabels.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = r.parentElement;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(e.target.value === 'dark'){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = '#fff';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = '#000';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  /* --------------
Â  Â  Â  Â  Â  Icons (local files expected in assets/map_images/)
Â  Â  Â  Â  Â  -------------- */
Â  Â  Â  Â  const icons = {
Â  Â  Â  Â  Â  Â  // ğŸ”‘ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… assets/map_images/
Â  Â  Â  Â  Â  Â  electric: L.icon({iconUrl:"assets/map_images/electrictrans.png", iconSize:[26,26]}),
Â  Â  Â  Â  Â  Â  networking: L.icon({iconUrl:"assets/map_images/networking.png", iconSize:[26,26]}),
Â  Â  Â  Â  Â  Â  valve: L.icon({iconUrl:"assets/map_images/valve.png", iconSize:[26,26]}),
Â  Â  Â  Â  Â  Â  sewer: L.icon({iconUrl:"assets/map_images/sewer.png", iconSize:[26,26]}),
Â  Â  Â  Â  Â  Â  // ØªÙ… Ø§ÙØªØ±Ø§Ø¶ Ø§Ø³Ù… Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø±ÙØ¹: sewer_station.png
Â  Â  Â  Â  Â  Â  station: L.icon({iconUrl:"assets/map_images/sewer_station.png", iconSize:[28,28]}),
Â  Â  Â  Â  Â  Â  rober: L.icon({iconUrl:"assets/map_images/rober.png", iconSize:[28,28]})
Â  Â  Â  Â  };

Â  Â  Â  Â  /* --------------------------
Â  Â  Â  Â  Â  Layers metadata (your GeoJSON files)
Â  Â  Â  Â  Â  -------------------------- */
Â  Â  Â  Â  const layersInfo = {
Â  Â  Â  Â  Â  Â  "Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡": {file:"layers/electric_lines.geojson", color:"#ff0000"},
Â  Â  Â  Â  Â  Â  "Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡": {file:"layers/electric_points.geojson", icon:icons.electric},
Â  Â  Â  Â  Â  Â  "Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª": {file:"layers/landline_lines.geojson", color:"#00cc66"},
Â  Â  Â  Â  Â  Â  "Ù†Ù‚Ø§Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª": {file:"layers/landline_points.geojson", icon:icons.networking},
Â  Â  Â  Â  Â  Â  "Ø®Ø·ÙˆØ· Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°": {file:"layers/water_lines.geojson", color:"#007bff"},
Â  Â  Â  Â  Â  Â  "Ù…Ø­Ø§Ø¨Ø³ Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°": {file:"layers/water_points.geojson", icon:icons.valve},
Â  Â  Â  Â  Â  Â  "Ø®Ø·ÙˆØ· Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ ğŸ’§": {file:"layers/Sewer_line.geojson", color:"#800080"},
Â  Â  Â  Â  Â  Â  "ØºØ±Ù ØªÙØªÙŠØ´ Ø§Ù„ØµØ±Ù": {file:"layers/Sewer_points3.geojson", icon:icons.sewer},
Â  Â  Â  Â  Â  Â  "ØºØ±Ù ØºØ³ÙŠÙ„ Ø§Ù„ØµØ±Ù": {file:"layers/Sewer_points2.geojson", icon:icons.sewer},
Â  Â  Â  Â  Â  Â  "ØºØ±Ù ØµØ±Ù ØµØ­ÙŠ": {file:"layers/Sewer_points1.geojson", icon:icons.sewer},
Â  Â  Â  Â  Â  Â  "Ù…Ø­Ø·Ø© Ø§Ù„Ø±ÙØ¹": {file:"layers/Sewer_station.geojson", icon:icons.station},
Â  Â  Â  Â  Â  Â  "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢": {file:"layers/buildings.geojson", color:"#DEB887"},
Â  Â  Â  Â  Â  Â  "Ø±ÙˆØ¨ÙŠØ± ğŸ“": {file:"layers/rober.geojson", icon:icons.rober}
Â  Â  Â  Â  };

Â  Â  Â  Â  /* Groups (for UI) */
Â  Â  Â  Â  const groups = {
Â  Â  Â  Â  Â  Â  "Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡": ["Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡","Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡"],
Â  Â  Â  Â  Â  Â  "Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª": ["Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª","Ù†Ù‚Ø§Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"],
Â  Â  Â  Â  Â  Â  "Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°": ["Ø®Ø·ÙˆØ· Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°","Ù…Ø­Ø§Ø¨Ø³ Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°"],
Â  Â  Â  Â  Â  Â  "Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ ğŸ’§": ["Ø®Ø·ÙˆØ· Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ ğŸ’§","ØºØ±Ù ØªÙØªÙŠØ´ Ø§Ù„ØµØ±Ù","ØºØ±Ù ØºØ³ÙŠÙ„ Ø§Ù„ØµØ±Ù","ØºØ±Ù ØµØ±Ù ØµØ­ÙŠ","Ù…Ø­Ø·Ø© Ø§Ù„Ø±ÙØ¹"],
Â  Â  Â  Â  Â  Â  "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹": ["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢","Ø±ÙˆØ¨ÙŠØ± ğŸ“"]
Â  Â  Â  Â  };

Â  Â  Â  Â  /* --------------------
Â  Â  Â  Â  Â  Load GeoJSON layers
Â  Â  Â  Â  Â  -------------------- */
Â  Â  Â  Â  let allLayers = {};
Â  Â  Â  Â  let layerBounds = {};
Â  Â  Â  Â  let loadedCount = 0;
Â  Â  Â  Â  const totalLayers = Object.keys(layersInfo).length;
Â  Â  Â  Â  const loaderOverlay = document.getElementById('loaderOverlay');

Â  Â  Â  Â  function checkAllLoadedAndFinish(){
Â  Â  Â  Â  Â  Â  if(loadedCount >= totalLayers){
Â  Â  Â  Â  Â  Â  Â  Â  // compute union bounds of all loaded layers
Â  Â  Â  Â  Â  Â  Â  Â  let union = null;
Â  Â  Â  Â  Â  Â  Â  Â  for(const k in layerBounds){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const b = layerBounds[k];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!b || typeof b.isValid !== 'function') continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(b.isValid()){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  union = union ? union.extend(b) : L.latLngBounds(b);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // if have union, fit to it; otherwise keep default view
Â  Â  Â  Â  Â  Â  Â  Â  if(union && union.isValid && union.isValid()){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.fitBounds(union, {padding:[60,60]});
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // hide loader
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(()=> {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loaderOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  for(const [name, info] of Object.entries(layersInfo)){
Â  Â  Â  Â  Â  Â  fetch(info.file).then(r=>{
Â  Â  Â  Â  Â  Â  Â  Â  if(!r.ok) throw new Error('HTTP '+r.status);
Â  Â  Â  Â  Â  Â  Â  Â  return r.json();
Â  Â  Â  Â  Â  Â  }).then(data=>{
Â  Â  Â  Â  Â  Â  Â  Â  const layer = L.geoJSON(data, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style: feat=>{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(name === "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢") return {color:"#8B4513", weight:1, fillColor:"#DEB887", fillOpacity:0.4};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {color: info.color || "#3388ff", weight:2, fillOpacity:0.7};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointToLayer: (feat, latlng) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(info.icon) return L.marker(latlng, {icon: info.icon});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // fallback for points: small circle marker
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return L.circleMarker(latlng, {radius:6, fillColor: info.color||'#3388ff', color:'#fff', weight:1, fillOpacity:0.9});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onEachFeature: (feat, layerInstance) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(feat.properties){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(const k in feat.properties){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<b>${k}:</b> ${feat.properties[k]}<br>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html = '<i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµØ§Ø¦Øµ</i>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layerInstance.bindPopup(html);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  allLayers[name] = layer;
Â  Â  Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const b = layer.getBounds();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layerBounds[name] = b && b.isValid && b.isValid() ? b : null;
Â  Â  Â  Â  Â  Â  Â  Â  }catch(err){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layerBounds[name] = null;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // show default layers if desired (like buildings + rober)
Â  Â  Â  Â  Â  Â  Â  Â  if(name === "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢" || name === "Ø±ÙˆØ¨ÙŠØ± ğŸ“"){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer(layer);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  loadedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  checkAllLoadedAndFinish();
Â  Â  Â  Â  Â  Â  }).catch(err=>{
Â  Â  Â  Â  Â  Â  Â  Â  console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø©:', info.file, err);
Â  Â  Â  Â  Â  Â  Â  Â  loadedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  checkAllLoadedAndFinish();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ------------------------------
Â  Â  Â  Â  Â  Build grouped layer list (UI)
Â  Â  Â  Â  Â  ------------------------------ */
Â  Â  Â  Â  const layerGroupsDiv = document.getElementById('layerGroups');

Â  Â  Â  Â  for(const [groupName, layerNames] of Object.entries(groups)){
Â  Â  Â  Â  Â  Â  const groupDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  groupDiv.className = 'layer-group collapsed'; // Ø§Ù„Ø¢Ù† Ù…ØºÙ„Ù‚Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹

Â  Â  Â  Â  Â  Â  const h4 = document.createElement('h4');
Â  Â  Â  Â  Â  Â  h4.textContent = groupName;
Â  Â  Â  Â  Â  Â  groupDiv.appendChild(h4);

Â  Â  Â  Â  Â  Â  const itemsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  itemsDiv.className = 'group-items';

Â  Â  Â  Â  Â  Â  layerNames.forEach(layerName=>{
Â  Â  Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  item.className = 'layer-item';
Â  Â  Â  Â  Â  Â  Â  Â  item.textContent = layerName;

Â  Â  Â  Â  Â  Â  Â  Â  item.addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const layer = allLayers[layerName];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!layer){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // not yet loaded
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.style.background = '#fff3cd';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.innerHTML = layerName + ' (Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(map.hasLayer(layer)){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(layer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.style.background = '#f5f5f5';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer(layer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.style.background = '#e0ffe0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // fit to this layer if bounds available
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const b = layerBounds[layerName];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(b && b.isValid && b.isValid()){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.fitBounds(b, {padding:[60,60]});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  itemsDiv.appendChild(item);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  groupDiv.appendChild(itemsDiv);
Â  Â  Â  Â  Â  Â  layerGroupsDiv.appendChild(groupDiv);

Â  Â  Â  Â  Â  Â  // collapse/expand group
Â  Â  Â  Â  Â  Â  h4.addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  Â  Â  groupDiv.classList.toggle('collapsed');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /* -------------------------
Â  Â  Â  Â  Â  Controls: show/hide/reset
Â  Â  Â  Â  Â  ------------------------- */
Â  Â  Â  Â  document.getElementById('showAll').addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  for(const k in allLayers){
Â  Â  Â  Â  Â  Â  Â  Â  if(allLayers[k] && !map.hasLayer(allLayers[k])) map.addLayer(allLayers[k]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('hideAll').addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  for(const k in allLayers){
Â  Â  Â  Â  Â  Â  Â  Â  if(allLayers[k] && map.hasLayer(allLayers[k])) map.removeLayer(allLayers[k]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('resetMap').addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  map.setView([25.687,30.841], 16);
Â  Â  Â  Â  });

Â  Â  Â  Â  /* -------------------------
Â  Â  Â  Â  Â  Sidebar open/close and clicks
Â  Â  Â  Â  Â  ------------------------- */
Â  Â  Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  Â  Â  const toggleBtn = document.getElementById('toggleSidebar');

Â  Â  Â  Â  toggleBtn.addEventListener('click', (e)=>{
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  sidebar.classList.toggle('hidden');
Â  Â  Â  Â  Â  Â  const expanded = !sidebar.classList.contains('hidden');
Â  Â  Â  Â  Â  Â  toggleBtn.setAttribute('aria-expanded', expanded);
Â  Â  Â  Â  Â  Â  sidebar.setAttribute('aria-hidden', !expanded);
Â  Â  Â  Â  });
Â  Â  Â  Â  // prevent clicks inside sidebar from closing it
Â  Â  Â  Â  sidebar.addEventListener('click', e=> e.stopPropagation());
Â  Â  Â  Â  // close sidebar when clicking outside
Â  Â  Â  Â  document.addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  if(!sidebar.classList.contains('hidden')){
Â  Â  Â  Â  Â  Â  Â  Â  sidebar.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  sidebar.setAttribute('aria-hidden','true');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.setAttribute('aria-expanded','false');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  /* Accessibility: trap focus inside sidebar when opened (basic) */
Â  Â  Â  Â  sidebar.addEventListener('keydown', (e)=>{
Â  Â  Â  Â  Â  Â  if(e.key === 'Escape'){
Â  Â  Â  Â  Â  Â  Â  Â  sidebar.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  sidebar.setAttribute('aria-hidden','true');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.setAttribute('aria-expanded','false');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  /* Ensure loader is hidden if layers take too long (failsafe after 12s) */
Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  const overlay=document.getElementById('loaderOverlay');
Â  Â  Â  Â  Â  Â  if(overlay && overlay.style.display !== 'none'){
Â  Â  Â  Â  Â  Â  Â  Â  overlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 12000);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ğŸ–¨ï¸ ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
Â  Â  Â  Â  document.getElementById('printMapBtn').addEventListener('click', ()=>{ window.print(); });


Â  Â  Â  Â  // ğŸ”„ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ù…Ø¹ Ø³Ù‡Ù… Ø§Ù„Ø´Ù…Ø§Ù„)
Â  Â  Â  Â  let currentRotation = 0; // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
Â  Â  Â  Â  const mapContainer = document.getElementById("map");
Â  Â  Â  Â  const northArrow = document.getElementById("northArrow");

Â  Â  Â  Â  // Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø³Ù‡Ù…
Â  Â  Â  Â  function applyRotation(angle) {
Â  Â  Â  Â  Â  Â  currentRotation = angle % 360;
Â  Â  Â  Â  Â  Â  mapContainer.style.transform = `rotate(${currentRotation}deg)`;
Â  Â  Â  Â  Â  Â  northArrow.style.transform = `rotate(${-currentRotation}deg)`; // Ø¹ÙƒØ³ Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
Â  Â  Â  Â  }

Â  Â  Â  Â  // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø´Ù…Ø§Ù„ ØªØ¹ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
Â  Â  Â  Â  northArrow.addEventListener("click", () => {
Â  Â  Â  Â  Â  Â  applyRotation(0);
Â  Â  Â  Â  });

Â  Â  Â  Â  // ğŸ” ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø§Ù† Ø¹Ø¨Ø± Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
Â  Â  Â  Â  document.addEventListener("keydown", e => {
Â  Â  Â  Â  Â  Â  if (e.key === "ArrowLeft") applyRotation(currentRotation - 10); // ØªØ¯ÙˆÙŠØ± ÙŠØ³Ø§Ø±
Â  Â  Â  Â  Â  Â  if (e.key === "ArrowRight") applyRotation(currentRotation + 10); // ØªØ¯ÙˆÙŠØ± ÙŠÙ…ÙŠÙ†
Â  Â  Â  Â  });
Â  Â  Â  Â  // -------------------------------------------------
Â  Â  Â  Â  // ğŸ”‘ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©)
Â  Â  Â  Â  // -------------------------------------------------

Â  Â  Â  Â  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
Â  Â  Â  Â  document.getElementById("homeBtn").addEventListener("click", async () => {
Â  Â  Â  Â  Â  Â  Â // ğŸ”‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© checkUserSession Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
Â  Â  Â  Â  Â  Â  const user = await checkUserSession();Â 

Â  Â  Â  Â  Â  Â  if(!user || !user.role){
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  switch(user.role){
Â  Â  Â  Â  Â  Â  Â  Â  case "admin":
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "dashboard.html";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case "user":
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "user.html";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case "guest":
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "guest.html";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
Â  Â  Â  Â  document.getElementById("logoutBtn").addEventListener("click", () => {
Â  Â  Â  Â  Â  Â  logout(); // ğŸ”‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© logout Ù…Ù† auth.js
Â  Â  Â  Â  });
Â  Â  }

</script>
</body>
</html>
