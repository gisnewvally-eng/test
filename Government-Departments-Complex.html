<!DOCTYPE html>
<html lang="ar">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Ø®Ø±ÙŠØ·Ø© Ù…Ø±Ø§ÙÙ‚ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ§Ù„Ø­ Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© - Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</title>
<link rel="icon" type="image/png" href="logo.png" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="assets/js/auth.js"></script>
<script>
try {
  const sessionUser = JSON.parse(localStorage.getItem("loggedUser"));
  if (!sessionUser) {
    window.location.href = "index.html";
  } else {
    const allowedRoles = ["admin", "user"];
    if (!allowedRoles.includes(sessionUser.role)) {
      window.location.href = "index.html";
    }
  }
} catch (err) {
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù€ JSON Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¢Ø®Ø±
  console.error('session check error:', err);
  window.location.href = "index.html";
}
</script>

<script> protectPage(); </script>

<style>
  :root{
    --accent:#228B22;
    --green:#32CD32;
    --danger:#b22222;
    --sidebar-width:300px;
    --header-height:70px;
    --footer-height:70px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:0;
    direction:rtl;
    font-family:"Cairo",sans-serif;
    background:#ffffff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }

  /* Header */
  header{
    position:fixed;
    top:0; left:0; right:0;
    height:var(--header-height);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    background:linear-gradient(90deg,#00b09b,#96c93d);
    color:#fff;
    padding:10px;
    z-index:2200;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
  }
  header img.logo{
    height:48px;
    margin-inline-start:6px; /* logo on the right (rtl) */
  }
  header h1{
    margin:0;
    font-size:18px;
    font-weight:700;
    text-align:center;
  }

  /* Map centered area */
  #map{
    height:80vh;
    width:100%;
    margin-top:var(--header-height);
    margin-bottom:var(--footer-height);
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
  }

  /* Sidebar - its bottom aligns with the map bottom: height = 80vh and top = header height */
  #sidebar{
    position:fixed;
    top:var(--header-height);
    right:0;
    width:var(--sidebar-width);
    max-width:92%;
    height:80vh; /* same as map height */
    background:#fff;
    border-left:2px solid #32CD32;
    box-shadow:-2px 0 8px rgba(0,0,0,0.12);
    overflow-y:auto;
    z-index:2000;
    padding:14px 12px 18px 12px;
    border-radius:0 8px 8px 0;
    transition:transform .28s ease, background .2s ease;
  }
  #sidebar.hidden{ transform: translateX(100%); }

  /* Sidebar sections */
  .sidebar-section{ margin-bottom:12px; padding-top:8px; }
  .sidebar-section h3{
    margin:0 0 8px 0;
    font-size:15px;
    color:var(--accent);
    font-weight:700;
  }
  /* in dark mode heads become white - controlled by .dark on sidebar */
  #sidebar.dark .sidebar-section h3{ color:#fff; }

  /* controls buttons */
  .controls{ display:flex; flex-direction:column; gap:8px; }
  .controls button{
    border:none;
    padding:10px;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.1);
  }
  .controls .show{ background:var(--green); color:#000; }
  .controls .hide{ background:var(--danger); color:#fff; }
  .controls .reset{ background: #f0f9f0; color:#000; border:1px solid #cfe9cf; }

  /* layer groups & items */
  .layer-group{ margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px; }
  .layer-group h4{
    margin:6px 0;
    font-size:14px;
    color:var(--accent);
    cursor:pointer;
    user-select:none;
  }
  .layer-group.collapsed > .group-items{ display:none; }
  .group-items{ padding-top:6px; display:block; }
  .layer-item{
    background: rgba(245, 245, 245, 0.7); /* Ø§Ù„Ø´ÙØ§ÙÙŠØ© 70% */
    color:#000; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ø³ÙˆØ¯ */
    padding:8px 10px;
    border-radius:6px;
    margin-bottom:8px;
    cursor:pointer;
    transition: background .12s, transform .06s;
    font-size:14px;
}

.layer-item:hover{ 
    background: rgba(232, 255, 232, 0.9); /* Ø£Ø®Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
    transform: translateY(-1px); 
}

  /* Footer */
footer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background:linear-gradient(90deg,#00b09b,#96c93d);
    color: #fff;
    display: flex;
    flex-direction: column; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø£Ø¹Ù…Ø¯Ø© */
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: 700;
    padding: 6px 0;
    z-index: 2000;
}

footer .line2 {
    font-weight: 600;
    font-size: 13px;
    margin-top: 2px;
}


/* ğŸ“ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© */
.top-buttons {
  position: fixed;
  top: calc(var(--header-height) + 10px);
  right: 10px;
  z-index: 2050;
  display: flex;
  gap: 10px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±ÙŠÙ† */
}

/* Ø²Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
#toggleSidebar {
  background: linear-gradient(90deg, #00b09b, #96c93d);
  color: #fff;
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 800;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, opacity 0.2s;
}

#toggleSidebar:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

/* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
#printMapBtn {
  background: linear-gradient(90deg, #96c93d, #00b09b);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 20px;
  padding: 12px 16px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, opacity 0.2s;
}

#printMapBtn:hover {
  transform: scale(1.05);
  opacity: 0.9;
}
/* ğŸ“Œ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© */
#homeBtn, #logoutBtn {
  background: linear-gradient(90deg, #00b09b, #96c93d); /* Ù†ÙØ³ Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
  color: #fff;
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 800;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, opacity 0.2s;
}

#homeBtn:hover, #logoutBtn:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

/* ğŸ¯ Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
  .leaflet-control-zoom {
    display: none !important;
  }
}

  
/* ğŸ“„ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© â€” Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±ÙŠÙ† */
@media print {
  .top-buttons { display: none; }
  header, footer {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}

/* ğŸ“± ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§ØªÙ: Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
@media (max-width: 600px) {
  #printMapBtn {
    left: 50%;
    transform: translateX(-50%);
    top: calc(var(--header-height) + 8px);
  }
}

/* ğŸ–¨ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
  /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
  #toggleSidebar,
  #printMapBtn {
    display: none !important;
  }

  /* Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØºØ·ÙŠ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
  #map {
    height: 80vh !important;
  }

  /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
  header,
  footer {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
}


  /* Loader overlay fullscreen */
  #loaderOverlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    background: rgba(0,0,0,0.45);
    z-index:3000;
  }
  #loaderBox{
    background: rgba(255,255,255,0.95);
    padding:22px;
    border-radius:12px;
    display:flex;
    align-items:center;
    gap:14px;
    box-shadow:0 6px 30px rgba(0,0,0,0.25);
  }
  #loaderBox img{ height:64px; width:auto; display:block; }
  .spinner{
    width:44px; height:44px;
    border-radius:50%;
    border:6px solid rgba(0,0,0,0.08);
    border-top-color:var(--accent);
    animation:spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* Dark mode on sidebar: change bg but keep item text black (as requested) */
  #sidebar.dark{ background:#111; }
  #sidebar.dark .layer-item{ background:#222; color:#000; } /* dark bg but text black */

  /* Responsive */
  @media (max-width:900px){
    :root{ --sidebar-width:75vw; }
    #sidebar{ width:75vw; left: auto; right:0; }
    #toggleSidebar{ right:8px; top: calc(var(--header-height)+8px); }
    header img.logo{ height:44px; }
    header h1{ font-size:16px; }
  }
  /* Ø¶ÙŠÙ‚ Ø£ÙƒØ«Ø± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width:600px){
  :root { --sidebar-width:60vw; } /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ */
  #sidebar{ width: var(--sidebar-width); }
}

  @media (max-width:480px){
    #map{ height:70vh; }
    #sidebar{ height:70vh; top:var(--header-height); }
    .floating-buttons button{ min-width:34px; height:34px; font-size:15px; }
  }
/* ğŸ”¹ North Arrow Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
#map #northArrow {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 60px;
  height: 60px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  cursor: pointer; /* âœ… Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡ */
  transition: transform 0.5s ease;
}

#map #northArrow::after {
  content: "";
  display: block;
  width: 40px;
  height: 40px;
  background: url('north.png') no-repeat center/contain;
}

/* ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
body.dark-mode #map #northArrow {
  background: rgba(0, 0, 0, 0.6);
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
}

/* ğŸ”¸ ÙÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
@media (max-width: 768px) {
  #map #northArrow {
    bottom: 90px; /* Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ÙÙˆØªØ± */
    left: 15px;
  }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header-buttons {
  position: absolute;
  left: 20px; /* Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ (rtl) */
  top: 15px;
  display: flex;
  gap: 10px;
  z-index: 2300;
}

/* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø¬ÙˆØ§Ù„ ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙ‚Ø· */
@media (max-width: 600px) {
  .header-buttons {
    position: relative;
    top: 4px;
    left: auto;
    justify-content: center;
    margin-top: 4px;
  }
  #homeBtn, #logoutBtn {
    width: 40px;
    height: 40px;
    padding: 0;
    font-size: 0; /* Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ */
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #homeBtn::before {
    content: "ğŸ ";
    font-size: 20px;
  }
  #logoutBtn::before {
    content: "ğŸšª";
    font-size: 20px;
  }
}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
  .header-buttons { display: none !important; }
}

</style>
</head>
<body>

  <!-- Loader overlay (covers whole page) -->
  <div id="loaderOverlay">
    <div id="loaderBox" role="status" aria-live="polite">
      <img src="logo.png" alt="Logo">
      <div>
        <div class="spinner" aria-hidden="true"></div>
        <div style="margin-top:8px;font-weight:700;color:#222;text-align:right">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª...</div>
      </div>
    </div>
  </div>

 <!-- Header with logo on the right (RTL) -->
<header id="header">
  <img src="logo.png" class="logo" alt="Ø´Ø¹Ø§Ø±">
  <h1>Ø®Ø±ÙŠØ·Ø© Ù…Ø±Ø§ÙÙ‚ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ§Ù„Ø­ Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©<br> Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h1>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
  <div class="header-buttons">
    <button id="homeBtn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

 <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ -->
<div class="top-buttons">
  <button id="toggleSidebar" aria-controls="sidebar" aria-expanded="false">â˜° Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</button>
  <button id="printMapBtn" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ–¨ï¸</button>
</div>

  <!-- Sidebar -->
  <aside id="sidebar" class="hidden" aria-hidden="true">
    
   <div style="height:28px;"></div>


    <!-- Basemap selection -->
    <div class="sidebar-section" style="padding-top:40px;">
      <h3>Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
      <div style="padding:6px 2px;"><label><input type="radio" name="basemap" value="osm" checked> ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ø±Ù‚</label></div>
      <div style="padding:6px 2px;"><label><input type="radio" name="basemap" value="satellite"> ğŸ›°ï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</label></div>
      <div style="padding:6px 2px;"><label><input type="radio" name="basemap" value="dark"> ğŸŒ‘ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡</label></div>
    </div>

    <!-- Controls -->
    <div class="sidebar-section">
      <h3>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h3>
      <div class="controls">
        <button id="showAll" class="show">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</button>
        <button id="hideAll" class="hide">Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</button>
        <button id="resetMap" class="reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶</button>
      </div>
    </div>

    <!-- Layer groups -->
    <div class="sidebar-section">
      <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h3>
      <div id="layerGroups" aria-live="polite"></div>
    </div>
  </aside>

  <!-- Map -->
  <div id="map" role="application" aria-label="Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚">
  <!-- Ø³Ù‡Ù… Ø§Ù„Ø´Ù…Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªÙƒÙˆÙ† Ø·Ø¨Ù‚Ø§ØªÙ‡ Ù…Ø±ØªØ¨Ø© -->
  <div id="northArrow" title="Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø´Ù…Ø§Ù„"></div>
  </div>

  <!-- Footer -->
  <footer>
    Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù‡Ø§Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ - Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    <span class="line2">Designed By Eng. Ahmed Labib </span>
  </footer>

<script>
/* -----------------------
   Base maps and Map init
   ----------------------- */
const baseMaps = {
  osm: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:'Â© OpenStreetMap contributors'}),
  satellite: L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19}),
  dark: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19})
};

const map = L.map('map', {
  center:[25.687,30.841],
  zoom:16,
  layers:[baseMaps.osm],
  zoomControl:true
});

/* Toggle header/sidebar dark class when dark basemap chosen */
function setDarkMode(isDark){
  const sidebar=document.getElementById('sidebar');
  const header=document.getElementById('header');
  sidebar.classList.toggle('dark', isDark);
  header.classList.toggle('dark', isDark);
}
document.querySelectorAll('input[name="basemap"]').forEach(radio => {
  radio.addEventListener("change", e => {
    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    map.eachLayer(l => { if(l instanceof L.TileLayer) map.removeLayer(l); });
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    map.addLayer(baseMaps[e.target.value]);

    // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„
    setDarkMode(e.target.value === "dark");

    // Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    if(allLayers["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢"]){
      if(e.target.value === "satellite"){
        map.removeLayer(allLayers["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢"]);
      } else {
        map.addLayer(allLayers["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢"]);
      }
    }
  });
});

// ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ù†Øµ Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡
// Ø§Ø³ØªÙ‡Ø¯Ø§Ù ÙƒÙ„ Ø§Ù„Ù€ labels Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
const basemapLabels = document.querySelectorAll('input[name="basemap"]');

basemapLabels.forEach(radio => {
  radio.addEventListener('change', e => {
    basemapLabels.forEach(r => {
      const label = r.parentElement; // Ø§Ù„Ù€ label Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù€ input
      if(e.target.value === 'dark'){
        label.style.color = '#fff'; // Ø§Ù„Ù†Øµ Ø£Ø¨ÙŠØ¶
      } else {
        label.style.color = '#000'; // Ø§Ù„Ù†Øµ Ø£Ø³ÙˆØ¯
      }
    });
  });
});

/* --------------
   Icons (local files expected in repo)
   -------------- */
const icons = {
  electric: L.icon({iconUrl:"electrictrans.png", iconSize:[26,26]}),
  networking: L.icon({iconUrl:"networking.png", iconSize:[26,26]}),
  valve: L.icon({iconUrl:"valve.png", iconSize:[26,26]}),
  sewer: L.icon({iconUrl:"sewer.png", iconSize:[26,26]}),
  station: L.icon({iconUrl:"Ù…Ø­Ø·Ø©_Ø§Ù„Ø±ÙØ¹-removebg-preview.png", iconSize:[28,28]}),
  rober: L.icon({iconUrl:"rober.png", iconSize:[28,28]})
};

/* --------------------------
   Layers metadata (your GeoJSON files)
   -------------------------- */
const layersInfo = {
  "Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡": {file:"layers/electric_lines.geojson", color:"#ff0000"},
  "Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡": {file:"layers/electric_points.geojson", icon:icons.electric},
  "Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª": {file:"layers/landline_lines.geojson", color:"#00cc66"},
  "Ù†Ù‚Ø§Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª": {file:"layers/landline_points.geojson", icon:icons.networking},
  "Ø®Ø·ÙˆØ· Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°": {file:"layers/water_lines.geojson", color:"#007bff"},
  "Ù…Ø­Ø§Ø¨Ø³ Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°": {file:"layers/water_points.geojson", icon:icons.valve},
  "Ø®Ø·ÙˆØ· Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ ğŸ’§": {file:"layers/Sewer_line.geojson", color:"#800080"},
  "ØºØ±Ù ØªÙØªÙŠØ´ Ø§Ù„ØµØ±Ù": {file:"layers/Sewer_points3.geojson", icon:icons.sewer},
  "ØºØ±Ù ØºØ³ÙŠÙ„ Ø§Ù„ØµØ±Ù": {file:"layers/Sewer_points2.geojson", icon:icons.sewer},
  "ØºØ±Ù ØµØ±Ù ØµØ­ÙŠ": {file:"layers/Sewer_points1.geojson", icon:icons.sewer},
  "Ù…Ø­Ø·Ø© Ø§Ù„Ø±ÙØ¹": {file:"layers/Sewer_station.geojson", icon:icons.station},
  "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢": {file:"layers/buildings.geojson", color:"#DEB887"},
  "Ø±ÙˆØ¨ÙŠØ± ğŸ“": {file:"layers/rober.geojson", icon:icons.rober}
};

/* Groups (for UI) */
const groups = {
  "Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡": ["Ø®Ø·ÙˆØ· Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡","Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ âš¡"],
  "Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª": ["Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª","Ù†Ù‚Ø§Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"],
  "Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°": ["Ø®Ø·ÙˆØ· Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°","Ù…Ø­Ø§Ø¨Ø³ Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸš°"],
  "Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ ğŸ’§": ["Ø®Ø·ÙˆØ· Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ ğŸ’§","ØºØ±Ù ØªÙØªÙŠØ´ Ø§Ù„ØµØ±Ù","ØºØ±Ù ØºØ³ÙŠÙ„ Ø§Ù„ØµØ±Ù","ØºØ±Ù ØµØ±Ù ØµØ­ÙŠ","Ù…Ø­Ø·Ø© Ø§Ù„Ø±ÙØ¹"],
  "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹": ["Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢","Ø±ÙˆØ¨ÙŠØ± ğŸ“"]
};

/* --------------------
   Load GeoJSON layers
   -------------------- */
let allLayers = {};
let layerBounds = {};
let loadedCount = 0;
const totalLayers = Object.keys(layersInfo).length;
const loaderOverlay = document.getElementById('loaderOverlay');

function checkAllLoadedAndFinish(){
  if(loadedCount >= totalLayers){
    // compute union bounds of all loaded layers
    let union = null;
    for(const k in layerBounds){
      const b = layerBounds[k];
      if(!b || typeof b.isValid !== 'function') continue;
      if(b.isValid()){
        union = union ? union.extend(b) : L.latLngBounds(b);
      }
    }
    // if have union, fit to it; otherwise keep default view
    if(union && union.isValid && union.isValid()){
      map.fitBounds(union, {padding:[60,60]});
    }
    // hide loader
    setTimeout(()=> {
      loaderOverlay.style.display = 'none';
    }, 300);
  }
}

for(const [name, info] of Object.entries(layersInfo)){
  fetch(info.file).then(r=>{
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }).then(data=>{
    const layer = L.geoJSON(data, {
      style: feat=>{
        if(name === "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢") return {color:"#8B4513", weight:1, fillColor:"#DEB887", fillOpacity:0.4};
        return {color: info.color || "#3388ff", weight:2, fillOpacity:0.7};
      },
      pointToLayer: (feat, latlng) => {
        if(info.icon) return L.marker(latlng, {icon: info.icon});
        // fallback for points: small circle marker
        return L.circleMarker(latlng, {radius:6, fillColor: info.color||'#3388ff', color:'#fff', weight:1, fillOpacity:0.9});
      },
      onEachFeature: (feat, layerInstance) => {
        let html = '';
        if(feat.properties){
          for(const k in feat.properties){
            html += `<b>${k}:</b> ${feat.properties[k]}<br>`;
          }
        } else {
          html = '<i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµØ§Ø¦Øµ</i>';
        }
        layerInstance.bindPopup(html);
      }
    });

    allLayers[name] = layer;
    try{
      const b = layer.getBounds();
      layerBounds[name] = b && b.isValid && b.isValid() ? b : null;
    }catch(err){
      layerBounds[name] = null;
    }

    // show default layers if desired (like buildings + rober)
    if(name === "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ğŸ¢" || name === "Ø±ÙˆØ¨ÙŠØ± ğŸ“"){
      map.addLayer(layer);
    }

    loadedCount++;
    checkAllLoadedAndFinish();
  }).catch(err=>{
    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø©:', info.file, err);
    loadedCount++;
    checkAllLoadedAndFinish();
  });
}

/* ------------------------------
   Build grouped layer list (UI)
   ------------------------------ */
const layerGroupsDiv = document.getElementById('layerGroups');

for(const [groupName, layerNames] of Object.entries(groups)){
 const groupDiv = document.createElement('div');
groupDiv.className = 'layer-group collapsed'; // Ø§Ù„Ø¢Ù† Ù…ØºÙ„Ù‚Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹

  const h4 = document.createElement('h4');
  h4.textContent = groupName;
  groupDiv.appendChild(h4);

  const itemsDiv = document.createElement('div');
  itemsDiv.className = 'group-items';

  layerNames.forEach(layerName=>{
    const item = document.createElement('div');
    item.className = 'layer-item';
    item.textContent = layerName;

    item.addEventListener('click', ()=>{
      const layer = allLayers[layerName];
      if(!layer){
        // not yet loaded
        item.style.background = '#fff3cd';
        item.innerHTML = layerName + ' (Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...)';
        return;
      }
      if(map.hasLayer(layer)){
        map.removeLayer(layer);
        item.style.background = '#f5f5f5';
      } else {
        map.addLayer(layer);
        item.style.background = '#e0ffe0';
        // fit to this layer if bounds available
        const b = layerBounds[layerName];
        if(b && b.isValid && b.isValid()){
          map.fitBounds(b, {padding:[60,60]});
        }
      }
    });

    itemsDiv.appendChild(item);
  });

  groupDiv.appendChild(itemsDiv);
  layerGroupsDiv.appendChild(groupDiv);

  // collapse/expand group
  h4.addEventListener('click', ()=>{
    groupDiv.classList.toggle('collapsed');
  });
}

/* -------------------------
   Controls: show/hide/reset
   ------------------------- */
document.getElementById('showAll').addEventListener('click', ()=>{
  for(const k in allLayers){
    if(allLayers[k] && !map.hasLayer(allLayers[k])) map.addLayer(allLayers[k]);
  }
});
document.getElementById('hideAll').addEventListener('click', ()=>{
  for(const k in allLayers){
    if(allLayers[k] && map.hasLayer(allLayers[k])) map.removeLayer(allLayers[k]);
  }
});
document.getElementById('resetMap').addEventListener('click', ()=>{
  map.setView([25.687,30.841], 16);
});

/* -------------------------
   Sidebar open/close and clicks
   ------------------------- */
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleSidebar');

toggleBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  sidebar.classList.toggle('hidden');
  const expanded = !sidebar.classList.contains('hidden');
  toggleBtn.setAttribute('aria-expanded', expanded);
  sidebar.setAttribute('aria-hidden', !expanded);
});
// prevent clicks inside sidebar from closing it
sidebar.addEventListener('click', e=> e.stopPropagation());
// close sidebar when clicking outside
document.addEventListener('click', ()=>{
  if(!sidebar.classList.contains('hidden')){
    sidebar.classList.add('hidden');
    sidebar.setAttribute('aria-hidden','true');
    toggleBtn.setAttribute('aria-expanded','false');
  }
});

/* Accessibility: trap focus inside sidebar when opened (basic) */
sidebar.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    sidebar.classList.add('hidden');
    sidebar.setAttribute('aria-hidden','true');
    toggleBtn.setAttribute('aria-expanded','false');
  }
});

/* Ensure loader is hidden if layers take too long (failsafe after 12s) */
setTimeout(()=>{
  const overlay=document.getElementById('loaderOverlay');
  if(overlay && overlay.style.display !== 'none'){
    overlay.style.display = 'none';
  }
}, 12000);
  
// ğŸ–¨ï¸ ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
document.getElementById('printMapBtn').addEventListener('click', ()=>{ window.print(); });


// ğŸ”„ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ù…Ø¹ Ø³Ù‡Ù… Ø§Ù„Ø´Ù…Ø§Ù„)
let currentRotation = 0; // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
const mapContainer = document.getElementById("map");
const northArrow = document.getElementById("northArrow");

// Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø³Ù‡Ù…
function applyRotation(angle) {
  currentRotation = angle % 360;
  mapContainer.style.transform = `rotate(${currentRotation}deg)`;
  northArrow.style.transform = `rotate(${-currentRotation}deg)`; // Ø¹ÙƒØ³ Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
}

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø´Ù…Ø§Ù„ ØªØ¹ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
northArrow.addEventListener("click", () => {
  applyRotation(0);
});

// ğŸ” ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø§Ù† Ø¹Ø¨Ø± Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft") applyRotation(currentRotation - 10); // ØªØ¯ÙˆÙŠØ± ÙŠØ³Ø§Ø±
  if (e.key === "ArrowRight") applyRotation(currentRotation + 10); // ØªØ¯ÙˆÙŠØ± ÙŠÙ…ÙŠÙ†
});
// -------------------------------------------------
// Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
// -------------------------------------------------

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
document.getElementById("homeBtn").addEventListener("click", () => {
  window.location.href = "dashboard.html"; // Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("loggedUser");
  window.location.href = "index.html"; // Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©
});


</script>
</body>
</html>





















