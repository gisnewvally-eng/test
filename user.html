<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Panel - Ø¬Ù‡Ø§Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
/* ---------------------------------
   ÙƒÙˆØ¯ CSS Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
   --------------------------------- */
body { margin:0; font-family:sans-serif; direction:rtl; }
header { background: linear-gradient(90deg,#00F260,#0575E6); color:white; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; position: fixed; top:0; left:0; right:0; z-index:1001; }
header span { font-weight:bold; }
header a { color:white; text-decoration:none; font-weight:bold; margin-left:15px; }
#toggleSidebar:hover { background: #26d0ce; }
.sidebar { width:220px; background:#2c3e50; color:white; position:fixed; top:70px; left:0; height:calc(100% - 70px); padding:20px; overflow-y:auto; transition: transform 0.3s ease; }
.sidebar.hidden { transform: translateX(-250px); }
.sidebar a { color:white; text-decoration:none; display:block; margin:12px 0; padding: 5px; }
.sidebar a:hover { background:#34495e; padding-left:10px; }
.main-content { margin-top:70px; margin-left:240px; padding:30px; padding-bottom:60px; }

/* Footer */
footer { position: fixed; bottom:0; left:0; right:0; background: linear-gradient(90deg,#00F260,#0575E6); color:#fff; display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; font-weight:700; padding:6px 0; z-index:1000; }
footer .line2 { font-weight:600; font-size:13px; margin-top:2px; }

</style>
</head>
<body>

<header>
Â  <div>Ù…Ø±Ø­Ø¨Ø§ØŒ <span id="userName"></span> (<span id="userRole"></span>)</div>
Â  <nav><a href="#" id="logoutLink">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></nav>
</header>
Â Â 
<div id="toggleSidebar" style="
Â  Â  position: fixed;
Â  Â  top: 80px;Â  Â  Â  Â 
Â  Â  left: 0;
Â  Â  width: 30px;
Â  Â  height: 30px;
Â  Â  background: #1a2980;
Â  Â  color: white;
Â  Â  font-size: 24px;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  border-radius: 0 5px 5px 0;
Â  Â  cursor: pointer;
Â  Â  z-index: 1100;">
Â  Â  &#9776;
</div>

<div class="sidebar">
Â  <h4>Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
Â  <div id="dynamicMapsLinks">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·...</div>
</div>

<div class="main-content">
Â  <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
Â  <p>Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙˆØ±Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.</p>
Â  
Â  <h3>Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙˆØ±Ùƒ</h3>
Â  <div id="availableMapsContent">
Â  Â  ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø±ÙŠØ·Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) Ù„ÙØªØ­Ù‡Ø§.
Â  </div>
</div>

<footer>
Â  Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù‡Ø§Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ - Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
Â  <span class="line2">Designed By Eng. Ahmed Labib </span>
</footer>

<script>
    // ------------------ 1. Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ------------------
    window.onload = async function() {
        
        // ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const userProfile = await protectPage(); 
        
        if (!userProfile) return; 

        // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ± (ÙŠØ³Ù…Ø­ Ù„Ù€ 'user' Ùˆ 'admin' Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„)
        if (userProfile.role !== 'user' && userProfile.role !== 'admin') {
            alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.');
            logout(); 
            return;
        }

        // ------------------ 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ------------------
        document.getElementById("userName").innerText = userProfile.email; 
        document.getElementById("userRole").innerText = userProfile.role;
        
        // ------------------ 3. ØªÙØ¹ÙŠÙ„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙØ­Ø© ÙˆSidebar ------------------
        
        // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        await loadDynamicMaps(userProfile.role);

        // Sidebar toggle
        const toggleBtn = document.getElementById("toggleSidebar");
        const sidebar = document.querySelector(".sidebar");
        toggleBtn.onclick = function() {
            sidebar.classList.toggle("hidden"); 
            toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;";
        };
        
        // ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
        document.getElementById("logoutLink").onclick = (e)=>{ 
            e.preventDefault(); 
            logout(); 
        };
    };

    /**
     * ğŸ—ºï¸ Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ù† Supabase
     * @param {string} role - Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
     */
    async function loadDynamicMaps(role) {
        const mapsContainer = document.getElementById("dynamicMapsLinks");
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† auth.js Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ù„Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
        const accessibleMaps = await getAccessibleMaps(role); 

        if (accessibleMaps.length === 0) {
            mapsContainer.innerHTML = "<p style='color: #ccc; font-size: 0.9em;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø±Ø§Ø¦Ø· Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙˆØ±Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
            return;
        }

        mapsContainer.innerHTML = ""; // Ù…Ø³Ø­ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„

        accessibleMaps.forEach(map => {
            const a = document.createElement("a");
            a.href = map.url;
            a.textContent = map.name;
            a.target = "_blank"; // Ù„ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
            mapsContainer.appendChild(a);
        });
    }
</script>
</body>
</html>
