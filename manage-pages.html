<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الخرائط</title>
<link rel="icon" type="image/png" href="logo.png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>
<script>
  window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
<script defer src="/_vercel/speed-insights/script.js"></script>
<style>
body { margin:0; font-family:"Cairo",sans-serif; direction:rtl; background:#f5f5f5; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; flex-wrap:wrap; }
header h1 { margin:0; font-size:18px; }
header .header-buttons { display:flex; gap:10px; flex-wrap:wrap; }
header button { background:#fff; color:#000; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:700; }

main { padding:20px; }
#mapsGrid { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }

.map-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:10px; display:flex; flex-direction:column; align-items:center; text-align:center; transition: transform 0.2s; }
.map-card:hover { transform: scale(1.03); }
.map-card img { width:70px; height:70px; object-fit:contain; margin-bottom:10px; transition: transform 0.2s; }
.map-card input[type="text"], .map-card select { width:90%; padding:6px; margin-bottom:6px; border-radius:6px; border:1px solid #ccc; text-align:center; font-size:14px; }
.roles { display:flex; justify-content:space-around; width:100%; margin-bottom:8px; flex-wrap:wrap; }
.roles label { font-size:12px; }
.map-card button { background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:700; margin-top:4px; font-size:13px; }

#addMapBtn { background:#fff; color:#000; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:700; }
#addMapModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
#addMapModal .modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:10px; }
#addMapModal select, #addMapModal input { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
#addMapModal button { padding:10px; border:none; border-radius:6px; font-weight:700; cursor:pointer; background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; font-size:14px; }

@media (max-width:900px){ #mapsGrid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width:600px){ #mapsGrid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>
  <h1>إدارة الخرائط</h1>
  <div class="header-buttons">
    <button onclick="logout()">تسجيل الخروج</button>
    <button onclick="window.location.href='dashboard.html'">العودة للداشبورد</button>
  </div>
</header>

<main>
  <div style="margin-bottom:16px;">
    <button id="addMapBtn">إضافة خريطة جديدة</button>
  </div>
  <div id="mapsGrid">جاري تحميل الخرائط...</div>
</main>

<div id="addMapModal">
  <div class="modal-content">
    <h3>إضافة خريطة جديدة</h3>
    <input type="text" id="newMapName" placeholder="اسم الخريطة">
    <input type="text" id="newMapURL" placeholder="رابط الخريطة">
    <select id="newMapType">
      <option value="سكنية">سكنية</option>
      <option value="صناعية">صناعية</option>
      <option value="تجارية">تجارية</option>
      <option value="خدمية">خدمية</option>
    </select>
    <div class="roles">
      <label><input type="checkbox" value="admin" checked> Admin</label>
      <label><input type="checkbox" value="user"> User</label>
      <label><input type="checkbox" value="guest"> Guest</label>
    </div>
    <div style="display:flex; gap:10px;">
      <button id="saveMapBtn">حفظ</button>
      <button id="cancelMapBtn" style="background:#ccc;color:#000;">إلغاء</button>
    </div>
  </div>
</div>

<script>
const mapsGrid = document.getElementById("mapsGrid");
const addMapBtn = document.getElementById("addMapBtn");
const addMapModal = document.getElementById("addMapModal");
const cancelMapBtn = document.getElementById("cancelMapBtn");
const saveMapBtn = document.getElementById("saveMapBtn");

function createMapCard(map){
  const card = document.createElement("div");
  card.className = "map-card";

  // صورة الخريطة
  const img = document.createElement("img");
  img.src = map.image_url || mapImages[map.type] || mapImages["سكنية"];
  card.appendChild(img);

  // الاسم
  const nameInput = document.createElement("input");
  nameInput.type="text"; 
  nameInput.value = map.name || ""; 
  nameInput.placeholder = "اسم الخريطة";
  card.appendChild(nameInput);

  // الرابط
  const urlInput = document.createElement("input");
  urlInput.type="text"; 
  urlInput.value = map.url || ""; 
  urlInput.placeholder = "رابط الخريطة";
  card.appendChild(urlInput);

  // النوع
  const typeSelect = document.createElement("select");
  ["سكنية","صناعية","تجارية","خدمية"].forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t; 
    opt.textContent = t;
    if(map.type === t) opt.selected = true;
    typeSelect.appendChild(opt);
  });
  card.appendChild(typeSelect);

  // الأدوار
  const roleDiv = document.createElement("div"); 
  roleDiv.className = "roles";
  ["admin","user","guest"].forEach(role=>{
    const label = document.createElement("label");
    const checkbox = document.createElement("input"); 
    checkbox.type = "checkbox";
    checkbox.value = role; // ← مهم
    checkbox.checked = map.allowed_roles?.includes(role) || false;
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(" " + role));
    roleDiv.appendChild(label);
  });
  card.appendChild(roleDiv);

  // زر حفظ التغييرات
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "حفظ التغييرات";
  saveBtn.onclick = async ()=>{
    const newName = nameInput.value.trim();
    const newURL = urlInput.value.trim();
    const newType = typeSelect.value;

    // قراءة الأدوار المحددة بشكل صحيح
    const newRoles = Array.from(roleDiv.querySelectorAll('input[type="checkbox"]'))
                          .filter(cb => cb.checked)
                          .map(cb => cb.value);

    if(newRoles.length === 0){
      alert("اختر على الأقل دور واحد");
      return;
    }

    // تحديث البيانات في Supabase
    const { error } = await supabaseClient.from('maps').update({
      name: newName,
      url: newURL,
      type: newType,
      allowed_roles: newRoles,
      image_url: mapImages[newType]
    }).eq('id', map.id);

    if(error){
      alert("حدث خطأ أثناء الحفظ: " + error.message);
      console.error(error);
      return;
    }

    img.src = mapImages[newType]; // تحديث الصورة
    alert("تم حفظ التغييرات بنجاح");
  };
  card.appendChild(saveBtn);

  // زر حذف
  const delBtn = document.createElement("button");
  delBtn.textContent = "حذف الخريطة";
  delBtn.style.background = "#e74c3c";
  delBtn.onclick = async ()=>{
    if(confirm("هل تريد حذف هذه الخريطة نهائياً؟")){
      await supabaseClient.from('maps').delete().eq('id', map.id);
      loadMapsGrid();
    }
  };
  card.appendChild(delBtn);

  return card;
}


async function loadMapsGrid(){
  mapsGrid.innerHTML = "جاري تحميل الخرائط...";
  const { data: maps, error } = await supabaseClient.from('maps').select("*");
  if(error){ mapsGrid.innerHTML = "حدث خطأ"; console.error(error); return; }
  mapsGrid.innerHTML = "";
  maps.forEach(m=>mapsGrid.appendChild(createMapCard(m)));
}

addMapBtn.onclick = ()=>addMapModal.style.display="flex";
cancelMapBtn.onclick = ()=>addMapModal.style.display="none";

saveMapBtn.onclick = async () => {
  const name = document.getElementById("newMapName").value.trim();
  const url = document.getElementById("newMapURL").value.trim();
  const type = document.getElementById("newMapType").value;

  if (!name) { alert("ادخل اسم الخريطة"); return; }
  if (!type || !mapImages[type]) { alert("اختر نوع صحيح"); return; }

  // جمع الأدوار المحددة
  const roles = Array.from(addMapModal.querySelectorAll('input[type="checkbox"]'))
                     .filter(cb => cb.checked)
                     .map(cb => cb.value);

  if (roles.length === 0) { alert("اختر على الأقل دور واحد"); return; }

  // حماية المستخدم من الحفظ بدون صلاحية
  const profile = JSON.parse(localStorage.getItem("sessionUser"));
  if (!profile || profile.role !== "admin") {
    alert("ليس لديك صلاحية إضافة الخرائط");
    return;
  }

  try {
    const { data, error } = await supabaseClient
      .from('maps')
      .insert({
        name,
        url,
        type,
        allowed_roles: roles,
        image_url: mapImages[type]
      })
      .select()
      .single(); // للحصول على السطر المضاف

    if (error) throw error;

    alert("تم إضافة الخريطة بنجاح");

    // إعادة تعيين حقول النموذج
    addMapModal.style.display = "none";
    document.getElementById("newMapName").value = "";
    document.getElementById("newMapURL").value = "";
    document.getElementById("newMapType").value = "سكنية";
    addMapModal.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = cb.value === "admin");

    // تحديث واجهة الخرائط
    loadMapsGrid();

  } catch (err) {
    console.error(err);
    alert("حدث خطأ أثناء إضافة الخريطة: " + err.message);
  }
};

  addMapModal.style.display="none";
  document.getElementById("newMapName").value="";
  document.getElementById("newMapURL").value="";
  document.getElementById("newMapType").value="سكنية";

  loadMapsGrid();

window.onload = async ()=>{
  const profile = await protectPage();
  if(!profile) return;
  if(profile.role!=='admin'){ alert("غير مسموح بالدخول"); logout(); return; }

  loadMapsGrid();
};
</script>

</body>
</html>



