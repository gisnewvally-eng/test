<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الخرائط</title>
<link rel="icon" type="image/png" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
  body { margin:0; font-family:"Cairo",sans-serif; direction:rtl; background:#f5f5f5; }
  header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; }
  header h1 { margin:0; font-size:18px; }
  header button { background:#fff; color:#000; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:700; margin-left:10px; }

  main { padding:20px; }
  #mapsGrid { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }

  .map-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:10px; display:flex; flex-direction:column; align-items:center; text-align:center; }
  .map-card img { width:80px; height:80px; object-fit:contain; margin-bottom:10px; }
  .map-card input[type="text"], .map-card select { width:90%; padding:6px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; text-align:center; }
  .roles { display:flex; justify-content:space-around; width:100%; margin-bottom:10px; }
  .roles label { font-size:14px; }
  .map-card button { background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:700; }

  @media (max-width:900px){ #mapsGrid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:600px){ #mapsGrid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>
  <h1>إدارة الخرائط</h1>
  <div>
    <button onclick="window.location.href='dashboard.html'">العودة للداشبورد</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
</header>

<main>
  <div style="margin-bottom:16px;">
    <button id="addMapBtn">إضافة خريطة جديدة</button>
  </div>
  <div id="mapsGrid">جاري تحميل الخرائط...</div>
</main>

<script>
// روابط الصور العامة
const mapImages = {
  "سكنية": "https://xemily-public.s3.amazonaws.com/residential.png",
  "صناعية": "https://xemily-public.s3.amazonaws.com/industrial.png",
  "تجارية": "https://xemily-public.s3.amazonaws.com/commercial.png",
  "خدمية": "https://xemily-public.s3.amazonaws.com/services.png"
};

// تحديث أي حقل في Supabase
async function updateMapField(mapId, fieldName, value) {
  const obj = {}; obj[fieldName] = value;
  const { error } = await supabaseClient.from('maps').update(obj).eq('id', mapId);
  if(error){ alert(`خطأ في تحديث ${fieldName}: ${error.message}`); }
}

// تحميل وعرض الخرائط
async function loadMapsGrid(){
  const grid = document.getElementById("mapsGrid");
  grid.innerHTML = "جاري تحميل الخرائط...";
  const allMaps = await getAccessibleMaps('admin');
  grid.innerHTML = "";

  allMaps.forEach((map)=>{
    const card = document.createElement("div");
    card.className = "map-card";

    // صورة الخريطة
    const img = document.createElement("img");
    img.src = mapImages[map.type] || mapImages["سكنية"];
    card.appendChild(img);

    // اختيار نوع الخريطة
    const typeSelect = document.createElement("select");
    ["سكنية","صناعية","تجارية","خدمية"].forEach(t=>{
      const opt = document.createElement("option"); opt.value=t; opt.textContent=t;
      if(map.type===t) opt.selected=true;
      typeSelect.appendChild(opt);
    });
    typeSelect.onchange = async e=>{
      const type = e.target.value;
      img.src = mapImages[type];
      await updateMapField(map.id,'type',type);
    };
    card.appendChild(typeSelect);

    // اسم الخريطة
    const nameInput = document.createElement("input");
    nameInput.type="text"; nameInput.value=map.name||""; nameInput.placeholder="اسم الخريطة";
    nameInput.onchange = e=>updateMapField(map.id,'name',e.target.value);
    card.appendChild(nameInput);

    // رابط الخريطة
    const urlInput = document.createElement("input");
    urlInput.type="text"; urlInput.value=map.url||""; urlInput.placeholder="رابط الخريطة";
    urlInput.onchange = e=>updateMapField(map.id,'url',e.target.value);
    card.appendChild(urlInput);

    // مربعات الأدوار
    const roleDiv = document.createElement("div"); roleDiv.className="roles";
    ["admin","user","guest"].forEach(role=>{
      const label = document.createElement("label");
      const checkbox = document.createElement("input"); checkbox.type="checkbox";
      checkbox.checked = map.allowed_roles?.includes(role)||false;
      checkbox.onchange = async e=>{
        let roles = Array.isArray(map.allowed_roles)?[...map.allowed_roles]:[];
        if(e.target.checked){ if(!roles.includes(role)) roles.push(role); }
        else { roles = roles.filter(r=>r!==role); }
        const { error } = await supabaseClient.from('maps').update({allowed_roles:roles}).eq('id',map.id);
        if(error){ alert("خطأ في تحديث الأدوار: "+error.message); e.target.checked=!e.target.checked; }
        else map.allowed_roles = roles;
      };
      label.appendChild(checkbox); label.appendChild(document.createTextNode(" "+role));
      roleDiv.appendChild(label);
    });
    card.appendChild(roleDiv);

    // زر حذف
    const delBtn = document.createElement("button");
    delBtn.textContent="حذف الخريطة";
    delBtn.onclick = async ()=>{
      if(confirm("هل تريد حذف هذه الخريطة نهائياً؟")){
        const success = await deleteMap(map.id);
        if(success){ alert("تم الحذف!"); loadMapsGrid(); }
      }
    };
    card.appendChild(delBtn);

    grid.appendChild(card);
  });
}

// إضافة خريطة جديدة
async function addNewMap(){
  const name = prompt("أدخل اسم الخريطة الجديدة:");
  if(!name) return;
  const type = prompt("اختر نوع الخريطة: سكنية، صناعية، تجارية، خدمية","سكنية");
  const success = await addMap(name,"https://placeholder-map-link.com",["admin"],type);
  if(success){ alert(`تمت إضافة الخريطة "${name}" بنجاح!`); loadMapsGrid(); }
}

// تحميل الصفحة وحمايتها
window.onload = async ()=>{
  const userProfile = await protectPage();
  if(!userProfile) return;
  if(userProfile.role!=='admin'){ alert("غير مسموح بالدخول"); logout(); return; }

  loadMapsGrid();
  document.getElementById("addMapBtn").onclick = addNewMap;
};
</script>

</body>
</html>
