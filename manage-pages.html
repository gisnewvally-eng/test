<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الخرائط</title>
<link rel="icon" type="image/png" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
  body { margin:0; font-family:"Cairo",sans-serif; direction:rtl; background:#f5f5f5; }
  header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; flex-wrap:wrap; }
  header h1 { margin:0; font-size:18px; }
  header .header-buttons { display:flex; gap:10px; flex-wrap:wrap; }
  header button { background:#fff; color:#000; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:700; }

  main { padding:20px; }
  #mapsGrid { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }

  .map-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:10px; display:flex; flex-direction:column; align-items:center; text-align:center; }
  .map-card img { width:80px; height:80px; object-fit:contain; margin-bottom:10px; }
  .map-card input[type="text"], .map-card select { width:90%; padding:6px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; text-align:center; }
  .roles { display:flex; justify-content:space-around; width:100%; margin-bottom:10px; flex-wrap:wrap; }
  .roles label { font-size:14px; }
  .map-card button { background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:700; margin-top:4px; }

  /* Modal لإضافة خريطة جديدة */
  #addMapModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
  #addMapModal .modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:10px; }
  #addMapModal select, #addMapModal input { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
  #addMapModal button { padding:10px; border:none; border-radius:6px; font-weight:700; cursor:pointer; background: linear-gradient(90deg,#00b09b,#96c93d); color:#fff; }

  @media (max-width:900px){ #mapsGrid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:600px){ #mapsGrid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>
  <h1>إدارة الخرائط</h1>
  <div class="header-buttons">
    <button onclick="logout()">تسجيل الخروج</button>
    <button onclick="window.location.href='dashboard.html'">العودة للداشبورد</button>
  </div>
</header>

<main>
  <div style="margin-bottom:16px;">
    <button id="addMapBtn">إضافة خريطة جديدة</button>
  </div>
  <div id="mapsGrid">جاري تحميل الخرائط...</div>
</main>

<!-- Modal لإضافة خريطة -->
<div id="addMapModal">
  <div class="modal-content">
    <h3>إضافة خريطة جديدة</h3>
    <input type="text" id="newMapName" placeholder="اسم الخريطة">
    <select id="newMapType">
      <option value="سكنية">سكنية</option>
      <option value="صناعية">صناعية</option>
      <option value="تجارية">تجارية</option>
      <option value="خدمية">خدمية</option>
    </select>
    <div style="display:flex; gap:10px;">
      <button id="saveMapBtn">حفظ</button>
      <button id="cancelMapBtn" style="background:#ccc;color:#000;">إلغاء</button>
    </div>
  </div>
</div>

<script>
// روابط الصور الجديدة من Supabase Storage
const mapImages = {
  "سكنية": "https://mvxjqtvmnibhxtfuufky.supabase.co/storage/v1/object/sign/map-type-images/images/residential.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV84ZWY1NmIyZC05OTFlLTQ5ODktODk4Ny1lZmFmZDM0ZDYzZGUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJtYXAtdHlwZS1pbWFnZXMvaW1hZ2VzL3Jlc2lkZW50aWFsLnBuZyIsImlhdCI6MTc2NDA1MjkwNiwiZXhwIjozMzMwMDA1MjkwNn0.fwamonkadN5dZvFj_JDukgpSJ21b15iMnLTd_7Efbeg",
  "صناعية": "https://mvxjqtvmnibhxtfuufky.supabase.co/storage/v1/object/sign/map-type-images/images/industrial.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV84ZWY1NmIyZC05OTFlLTQ5ODktODk4Ny1lZmFmZDM0ZDYzZGUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJtYXAtdHlwZS1pbWFnZXMvaW1hZ2VzL2luZHVzdHJpYWwucG5nIiwiaWF0IjoxNzY0MDUyODg5LCJleHAiOjMzMzAwMDUyODg5fQ.IpDPLXzF3qST0eGHKPqXiC1txCBMM9Yv7VnP8tanqp0",
  "تجارية": "https://mvxjqtvmnibhxtfuufky.supabase.co/storage/v1/object/sign/map-type-images/images/commercial.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV84ZWY1NmIyZC05OTFlLTQ5ODktODk4Ny1lZmFmZDM0ZDYzZGUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJtYXAtdHlwZS1pbWFnZXMvaW1hZ2VzL2NvbW1lcmNpYWwucG5nIiwiaWF0IjoxNzY0MDUyNzY2LCJleHAiOjMzMzAwMDUyNzY2fQ.PPujOQ5Jt1flV-dv3s3_iI77OvXHnV-J1CaIbLCZ5IQ",
  "خدمية": "https://mvxjqtvmnibhxtfuufky.supabase.co/storage/v1/object/sign/map-type-images/images/services.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV84ZWY1NmIyZC05OTFlLTQ5ODktODk4Ny1lZmFmZDM0ZDYzZGUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJtYXAtdHlwZS1pbWFnZXMvaW1hZ2VzL3NlcnZpY2VzLnBuZyIsImlhdCI6MTc2NDA1MjkyOSwiZXhwIjozMzMwMDA1MjkyOX0.vU5R8g6GKgJ_9JHRESXkNm8YNxJyiOkNM65x21qB29s"
};

// تحديث أي حقل في Supabase
async function updateMapField(mapId, fieldName, value) {
  const obj = {}; obj[fieldName] = value;
  const { error } = await supabaseClient.from('maps').update(obj).eq('id', mapId);
  if(error){ alert(`خطأ في تحديث ${fieldName}: ${error.message}`); }
}

// تحميل وعرض الخرائط
async function loadMapsGrid(){
  const grid = document.getElementById("mapsGrid");
  grid.innerHTML = "جاري تحميل الخرائط...";
  const allMaps = await getAccessibleMaps('admin');
  grid.innerHTML = "";

  allMaps.forEach((map)=>{
    const card = document.createElement("div");
    card.className = "map-card";

    // صورة الخريطة
    const img = document.createElement("img");
    img.src = map.image_url || mapImages[map.type] || mapImages["سكنية"];
    card.appendChild(img);

    // اختيار نوع الخريطة
    const typeSelect = document.createElement("select");
    ["سكنية","صناعية","تجارية","خدمية"].forEach(t=>{
      const opt = document.createElement("option"); opt.value=t; opt.textContent=t;
      if(map.type===t) opt.selected=true;
      typeSelect.appendChild(opt);
    });
    typeSelect.onchange = async e=>{
      const type = e.target.value;
      img.src = mapImages[type];
      await updateMapField(map.id,'type',type);
      await updateMapField(map.id,'image_url',mapImages[type]);
    };
    card.appendChild(typeSelect);

    // اسم الخريطة
    const nameInput = document.createElement("input");
    nameInput.type="text"; nameInput.value=map.name||""; nameInput.placeholder="اسم الخريطة";
    nameInput.onchange = e=>updateMapField(map.id,'name',e.target.value);
    card.appendChild(nameInput);

    // رابط الخريطة
    const urlInput = document.createElement("input");
    urlInput.type="text"; urlInput.value=map.url||""; urlInput.placeholder="رابط الخريطة";
    urlInput.onchange = e=>updateMapField(map.id,'url',e.target.value);
    card.appendChild(urlInput);

    // مربعات الأدوار
    const roleDiv = document.createElement("div"); roleDiv.className="roles";
    ["admin","user","guest"].forEach(role=>{
      const label = document.createElement("label");
      const checkbox = document.createElement("input"); checkbox.type="checkbox";
      checkbox.checked = map.allowed_roles?.includes(role)||false;
      checkbox.onchange = async e=>{
        let roles = Array.isArray(map.allowed_roles)?[...map.allowed_roles]:[];
        if(e.target.checked){ if(!roles.includes(role)) roles.push(role); }
        else { roles = roles.filter(r=>r!==role); }
        const { error } = await supabaseClient.from('maps').update({allowed_roles:roles}).eq('id',map.id);
        if(error){ alert("خطأ في تحديث الأدوار: "+error.message); e.target.checked=!e.target.checked; }
        else map.allowed_roles = roles;
      };
      label.appendChild(checkbox); label.appendChild(document.createTextNode(" "+role));
      roleDiv.appendChild(label);
    });
    card.appendChild(roleDiv);

    // زر حذف
    const delBtn = document.createElement("button");
    delBtn.textContent="حذف الخريطة";
    delBtn.onclick = async ()=>{
      if(confirm("هل تريد حذف هذه الخريطة نهائياً؟")){
        const success = await deleteMap(map.id);
        if(success){ alert("تم الحذف!"); loadMapsGrid(); }
      }
    };
    card.appendChild(delBtn);

    grid.appendChild(card);
  });
}

// فتح وغلق الـ modal
const addMapBtn = document.getElementById("addMapBtn");
const addMapModal = document.getElementById("addMapModal");
const cancelMapBtn = document.getElementById("cancelMapBtn");
addMapBtn.onclick = () => { addMapModal.style.display = "flex"; };
cancelMapBtn.onclick = () => { addMapModal.style.display = "none"; };

// حفظ الخريطة الجديدة من الـ modal
const saveMapBtn = document.getElementById("saveMapBtn");
saveMapBtn.onclick = async ()=>{
  const name = document.getElementById("newMapName").value.trim();
  const type = document.getElementById("newMapType").value;

  if(!name) return alert("ادخل اسم الخريطة");
  if(!type || !mapImages[type]) return alert("اختر نوع الخريطة صحيح");

  const { error } = await supabaseClient.from("maps").insert({
    name, type, url:"", allowed_roles:["admin"], image_url:mapImages[type]
  });
  if(error) return alert("خطأ: "+error.message);

  addMapModal.style.display = "none";
  document.getElementById("newMapName").value = "";
  document.getElementById("newMapType").value = "سكنية";
  alert("تمت إضافة الخريطة بنجاح!");
  loadMapsGrid();
};

// تحميل الصفحة وحمايتها
window.onload = async ()=>{
  const userProfile = await protectPage();
  if(!userProfile) return;
  if(userProfile.role!=='admin'){ alert("غير مسموح بالدخول"); logout(); return; }

  loadMapsGrid();
};
</script>

</body>
</html>
