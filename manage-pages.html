<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø·</title>
<link rel="icon" type="image/png" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
    /* ---------------------------------
       ÙƒÙˆØ¯ CSS (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
       --------------------------------- */
Â  body {
Â  Â  margin:0;
Â  Â  font-family:"Cairo",sans-serif;
Â  Â  direction:rtl;
Â  Â  background:#f5f5f5;
Â  }
Â  header {
Â  Â  display:flex;
Â  Â  justify-content:space-between;
Â  Â  align-items:center;
Â  Â  padding:10px 20px;
Â  Â  background: linear-gradient(90deg,#00b09b,#96c93d);
Â  Â  color:#fff;
Â  }
Â  header h1 { margin:0; font-size:18px; }
Â  header button {
Â  Â  background:#fff;
Â  Â  color:#000;
Â  Â  border:none;
Â  Â  padding:8px 14px;
Â  Â  border-radius:6px;
Â  Â  cursor:pointer;
Â  Â  font-weight:700;
Â  }

Â  main { padding:20px; }
Â  #mapsGrid {
Â  Â  display:grid;
Â  Â  grid-template-columns: repeat(3, 1fr);
Â  Â  gap:20px;
Â  }

Â  .map-card {
Â  Â  background:#fff;
Â  Â  border-radius:10px;
Â  Â  box-shadow:0 2px 8px rgba(0,0,0,0.1);
Â  Â  padding:10px;
Â  Â  display:flex;
Â  Â  flex-direction:column;
Â  Â  align-items:center;
Â  Â  text-align:center;
Â  }
Â  .map-card img {
Â  Â  width:80px;
Â  Â  height:80px;
Â  Â  object-fit:contain;
Â  Â  margin-bottom:10px;
Â  }
Â  .map-card input[type="text"] {
Â  Â  width:90%;
Â  Â  padding:6px;
Â  Â  margin-bottom:8px;
Â  Â  border-radius:6px;
Â  Â  border:1px solid #ccc;
Â  Â  text-align:center;
Â  }
Â  .roles {
Â  Â  display:flex;
Â  Â  justify-content:space-around;
Â  Â  width:100%;
Â  Â  margin-bottom:10px;
Â  }
Â  .roles label { font-size:14px; }
Â  .map-card button {
Â  Â  background: linear-gradient(90deg,#00b09b,#96c93d);
Â  Â  color:#fff;
Â  Â  border:none;
Â  Â  padding:8px 14px;
Â  Â  border-radius:6px;
Â  Â  cursor:pointer;
Â  Â  font-weight:700;
Â  }

Â  @media (max-width:900px){
Â  Â  #mapsGrid { grid-template-columns: repeat(2, 1fr); }
Â  }
Â  @media (max-width:600px){
Â  Â  #mapsGrid { grid-template-columns: 1fr; }
Â  }
</style>
</head>
<body>
<header>
Â  <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø·</h1>
Â  <div>
Â  Â  <button onclick="window.location.href='dashboard.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
Â  Â  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
Â  </div>
</header>
<main>
Â  <div style="margin-bottom:16px;">
Â  Â  <button id="addMapBtn">Ø¥Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
Â  Â  Â  </div>
Â  <div id="mapsGrid">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·...</div>
</main>

<script>
    // Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø© (Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±)
Â  Â  const availableImages = {
Â  Â  Â  Â  "Ø³ÙƒÙ†ÙŠØ©": "assets/images/residential.png",
Â  Â  Â  Â  "ØµÙ†Ø§Ø¹ÙŠØ©": "assets/images/industrial.png",
Â  Â  Â  Â  "ØªØ¬Ø§Ø±ÙŠØ©": "assets/images/commercial.png",
Â  Â  Â  Â  "Ø®Ø¯Ù…ÙŠØ©": "assets/images/services.png"
Â  Â  };
    
    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ÙŠÙ† ÙÙŠ Supabase
    async function updateMapField(mapId, fieldName, value) {
        const updateObject = {};
        updateObject[fieldName] = value;

        const { error } = await supabaseClient
            .from('maps')
            .update(updateObject)
            .eq('id', mapId);

        if (error) {
            alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ${fieldName}: ` + error.message);
            console.error(error);
        }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    async function loadMapsGrid(){
        const grid = document.getElementById("mapsGrid");
        grid.innerHTML = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

        // ğŸ”‘ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· (Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯ÙˆØ± 'admin' Ù„Ø¬Ù„Ø¨Ù‡Ø§ ÙƒÙ„Ù‡Ø§ Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ù…Ø¨Ø¯Ø£)
        // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø¯ÙˆØ±ØŒ ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© getAccessibleMaps
        // ÙˆÙ„ÙƒÙ† Ù„Ù„Ø¢Ù†ØŒ Ø³Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡.
        const allMaps = await getAccessibleMaps('admin'); 
        
        grid.innerHTML = "";

        allMaps.forEach((map)=>{
            const card = document.createElement("div");
            card.className = "map-card";

            const img = document.createElement("img");
            // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø­Ù‚Ù„ 'img' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DBØŒ Ù†Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ø© Ø«Ø§Ø¨ØªØ© Ø£Ùˆ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù…
            img.src = availableImages["Ø³ÙƒÙ†ÙŠØ©"]; 
            card.appendChild(img);

            // 1. Ø­Ù‚Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.value = map.name || "";
            nameInput.placeholder = "Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            nameInput.onchange = e => updateMapField(map.id, 'name', e.target.value); 
            card.appendChild(nameInput);
            
            // 2. Ø­Ù‚Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            const urlInput = document.createElement("input");
            urlInput.type = "text";
            urlInput.value = map.url || "";
            urlInput.placeholder = "Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            urlInput.onchange = e => updateMapField(map.id, 'url', e.target.value); 
            card.appendChild(urlInput);

            // 3. Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Roles Checkboxes)
            const roleDiv = document.createElement("div");
            roleDiv.className = "roles";
            ["admin","user","guest"].forEach(role=>{
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type="checkbox";
                // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ checkbox Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© allowed_roles Ù…Ù† Supabase
                checkbox.checked = map.allowed_roles?.includes(role) || false; 
                
                checkbox.onchange = async (e) => {
                    let currentRoles = Array.isArray(map.allowed_roles) ? [...map.allowed_roles] : [];
                    
                    if(e.target.checked){
                        if(!currentRoles.includes(role)) currentRoles.push(role);
                    } else {
                        currentRoles = currentRoles.filter(r=>r!==role);
                    }
                    
                    // ğŸ”‘ ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase
                    const { error } = await supabaseClient
                        .from('maps')
                        .update({ allowed_roles: currentRoles })
                        .eq('id', map.id);

                    if(error){
                        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: " + error.message);
                        e.target.checked = !e.target.checked; // Ø¹ÙƒØ³ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                    } else {
                        map.allowed_roles = currentRoles; // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ
                        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­!");
                    }
                };

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(" "+role));
                roleDiv.appendChild(label);
            });
            card.appendChild(roleDiv);
            
            // 4. Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Ø­Ø°Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
            deleteBtn.style.marginTop="15px";
            deleteBtn.onclick = async ()=>{
                if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")){
                    // ğŸ”‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© deleteMap Ù…Ù† auth.js
                    const success = await deleteMap(map.id); 
                    if(success){
                        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                        loadMapsGrid(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    }
                }
            };
            card.appendChild(deleteBtn);

            grid.appendChild(card);
        });
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©
    async function addNewMap(){
        const newMapName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
        if (!newMapName) return;

        // ğŸ”‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© addMap Ù…Ù† auth.js Ù„Ø¥Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø© Ø¨Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const success = await addMap(newMapName, "https://placeholder-map-link.com", ["admin"]);

        if (success) {
            alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© "${newMapName}" Ø¨Ù†Ø¬Ø§Ø­!`);
            loadMapsGrid(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        }
    }

    // ------------------ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© ------------------
Â  Â  window.onload = async () => {
        // ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
        const userProfile = await protectPage();
        
        if (!userProfile) return; 

        if (userProfile.role !== 'admin') {
            alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
            logout();
            return;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
Â  Â  Â  Â  loadMapsGrid();
Â  Â  Â  Â  document.getElementById("addMapBtn").onclick = addNewMap;
Â  Â  };
</script>
</body>
</html>
