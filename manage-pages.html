<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الخرائط</title>
<link rel="icon" type="image/png" href="logo.png">
<style>
  body {
    margin:0;
    font-family:"Cairo",sans-serif;
    direction:rtl;
    background:#f5f5f5;
  }
  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 20px;
    background: linear-gradient(90deg,#00b09b,#96c93d);
    color:#fff;
  }
  header h1 { margin:0; font-size:18px; }
  header button {
    background:#fff;
    color:#000;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
    font-weight:700;
  }

  main { padding:20px; }
  #mapsGrid {
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:20px;
  }

  .map-card {
    background:#fff;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    padding:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
  }
  .map-card img {
    width:80px;
    height:80px;
    object-fit:contain;
    margin-bottom:10px;
  }
  .map-card input[type="text"] {
    width:90%;
    padding:6px;
    margin-bottom:8px;
    border-radius:6px;
    border:1px solid #ccc;
    text-align:center;
  }
  .roles {
    display:flex;
    justify-content:space-around;
    width:100%;
    margin-bottom:10px;
  }
  .roles label { font-size:14px; }
  .map-card button {
    background: linear-gradient(90deg,#00b09b,#96c93d);
    color:#fff;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    cursor:pointer;
    font-weight:700;
  }

  @media (max-width:900px){
    #mapsGrid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width:600px){
    #mapsGrid { grid-template-columns: 1fr; }
  }
</style>
<script src="assets/js/auth.js"></script>
<script>
  // حماية الصفحة للأدمن فقط
  const user = protectPage();
  if(user.role !== 'admin'){
    alert("غير مسموح بالدخول لهذه الصفحة");
    window.location.href="dashboard.html";
  }

  // الصور المتاحة
  const availableImages = {
    "سكنية": "assets/images/residential.png",
    "صناعية": "assets/images/industrial.png",
    "تجارية": "assets/images/commercial.png",
    "خدمية": "assets/images/services.png"
  };

  let pagesList = JSON.parse(localStorage.getItem("pagesList") || "[]");

  function renderGrid(){
    const grid = document.getElementById("mapsGrid");
    grid.innerHTML = "";
    pagesList.forEach((page, index)=>{
      const card = document.createElement("div");
      card.className = "map-card";

      const img = document.createElement("img");
      img.src = page.img || availableImages["سكنية"];
      card.appendChild(img);
      img.style.cursor = "pointer";
      img.onclick = () => {
      if(page.url) window.open(page.url, "_blank");
      else alert("لا يوجد رابط للخريطة");
      };


      const input = document.createElement("input");
      input.type = "text";
      input.value = page.name || "";
      input.placeholder = "اسم الخريطة";
      input.oninput = e => page.name = e.target.value;
      card.appendChild(input);
      
      const urlInput = document.createElement("input");
      urlInput.type = "text";
      urlInput.value = page.url || "";
      urlInput.placeholder = "رابط الخريطة";
      urlInput.oninput = e => page.url = e.target.value;
      card.appendChild(urlInput);

      const roleDiv = document.createElement("div");
      roleDiv.className = "roles";
      ["admin","user","guest"].forEach(role=>{
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type="checkbox";
        checkbox.checked = page.roles?.includes(role) || false;
        checkbox.onchange = e => {
          if(e.target.checked){
            if(!page.roles) page.roles=[];
            page.roles.push(role);
          } else {
            page.roles = page.roles.filter(r=>r!==role);
          }
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" "+role));
        roleDiv.appendChild(label);
      });
      card.appendChild(roleDiv);

      const selectImgBtn = document.createElement("button");
      selectImgBtn.textContent = "تغيير الصورة";
      selectImgBtn.onclick = ()=>{
        let choice = prompt("اختر صورة: سكنية، صناعية، تجارية، خدمية");
        if(choice && availableImages[choice]){
          img.src = availableImages[choice];
          page.img = availableImages[choice];
        } else alert("اختيار غير صالح");
      };
      card.appendChild(selectImgBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "حذف الخريطة";
      deleteBtn.style.marginTop="6px";
      deleteBtn.onclick = ()=>{
        if(confirm("هل تريد حذف هذه الخريطة؟")){
          pagesList.splice(index,1);
          savePages();
          renderGrid();
        }
      };
      card.appendChild(deleteBtn);

      grid.appendChild(card);
    });
  }

  function savePages(){
    localStorage.setItem("pagesList", JSON.stringify(pagesList));
    alert("تم حفظ الخرائط");
  }

  function addNewPage(){
   pagesList.push({
  name:"خريطة جديدة",
  img: availableImages["سكنية"],
  roles:["admin"],
  url:""
});
    renderGrid();
  }

  window.onload = ()=>{
    renderGrid();
    document.getElementById("addPageBtn").onclick=addNewPage;
    document.getElementById("savePagesBtn").onclick=savePages;
  };
</script>
</head>
<body>
<header>
  <h1>إدارة الخرائط</h1>
  <div>
    <button onclick="window.location.href='dashboard.html'">العودة للداشبورد</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
</header>
<main>
  <div style="margin-bottom:16px;">
    <button id="addPageBtn">إضافة خريطة جديدة</button>
    <button id="savePagesBtn">حفظ التغييرات</button>
  </div>
  <div id="mapsGrid"></div>
</main>
</body>
</html>

