<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¶ÙŠÙ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
/* ---------------------------------
   CSS (ØªØ¨Ø³ÙŠØ· ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©)
   --------------------------------- */
body { margin:0; font-family:sans-serif; background:#f0f3f7; direction:rtl; }
header { background: linear-gradient(90deg, #1a2980, #26d0ce); color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
.content { padding:20px; }
.card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:25px; }
.map-card { 
    background:#f9f9f9; 
    border-radius:8px; 
    padding:15px; 
    margin-bottom:15px; 
    display:flex; 
    align-items:center; 
    gap:15px; 
    border-right: 5px solid #004b8d; 
}
.map-card a {
    text-decoration: none;
    color: #1a2980;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 15px;
}
.map-card img { width:40px; height:40px; object-fit:contain; }
.map-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<header>
Â  <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ - Ù„ÙˆØ­Ø© Ø§Ù„Ø¶ÙŠÙ (<span id="userName"></span>)</h2>
Â  <button onclick="logout()" style="padding:8px 15px;border:none;border-radius:6px;cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="content">

Â  <div class="card">
Â  Â  <h3>Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙˆØ±Ùƒ:</h3>
    <p>Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„ØªÙŠ Ø³Ù…Ø­ Ù„Ùƒ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„ÙŠÙ‡Ø§.</p>
Â  Â  <div id="guestMaps">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·...</div>
Â  </div>

Â  </div>

<script>
    // ------------------ 1. Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ------------------
    window.onload = async function() {
        
        // ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const userProfile = await protectPage(); 
        
        if (!userProfile) return; // protectPage Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹

        // âš ï¸ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¯ÙˆØ± ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰
        if (userProfile.role === 'admin') {
            window.location.href = "dashboard.html";
            return;
        } else if (userProfile.role === 'user') {
            window.location.href = "user.html";
            return;
        } else if (userProfile.role !== 'guest') {
            // Ø£ÙŠ Ø¯ÙˆØ± Ø¢Ø®Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
            logout(); 
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById("userName").innerText = userProfile.email; 
        
        // Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ø¶ÙŠÙ
        await renderGuestMaps();
    };

    /**
     * ğŸ—ºï¸ Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ù† Supabase Ù„Ø¯ÙˆØ± 'guest'
     */
   async function renderGuestMaps(){
    const mapsContainer = document.getElementById("guestMaps");
    
    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
    const allMaps = await getAccessibleMaps('guest'); // Ø£Ùˆ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø¨Ø¯ÙˆÙ† ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±

    // ØªØµÙÙŠØ© Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„ØªÙŠ ÙŠØ³Ù…Ø­ Ù„Ù„Ø¶ÙŠÙ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§
    const accessibleMaps = allMaps.filter(map => map.allowed_roles?.includes('guest'));

    if (accessibleMaps.length === 0) {
        mapsContainer.innerHTML = "<p style='color: #888; font-style: italic;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø±Ø§Ø¦Ø· Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙˆØ±Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</p>";
        return;
    }

    mapsContainer.innerHTML = ""; // Ù…Ø³Ø­ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„

    accessibleMaps.forEach(map => {
        const div = document.createElement("div");
        div.className = "map-card";

        const link = document.createElement("a");
        link.href = map.url;
        link.target = "_blank"; // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ± Ù…Ù† Supabase Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ØŒ Ù…Ø¹ ØµÙˆØ±Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© "Ø³ÙƒÙ†ÙŠØ©"
        const imgSrc = map.image_url || mapImages[map.type] || mapImages["Ø³ÙƒÙ†ÙŠØ©"];

        link.innerHTML = `<img src="${imgSrc}" alt="Ø®Ø±ÙŠØ·Ø©"><span>${map.name}</span>`;

        div.appendChild(link);
        mapsContainer.appendChild(div);
    });
}


</script>
</body>
</html>


