<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¶ÙŠÙ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
body { margin:0; font-family:sans-serif; background:#f0f3f7; direction:rtl; }
header { background: linear-gradient(90deg, #1a2980, #26d0ce); color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
.content { padding:20px; }
.card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:25px; }

.map-card { 
    background:#f9f9f9; 
    border-radius:8px; 
    padding:15px; 
    margin-bottom:15px; 
    display:flex; 
    align-items:center; 
    gap:15px; 
    border-right: 5px solid #004b8d; 
}
.map-card a {
    text-decoration: none;
    color: #1a2980;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 15px;
}
.map-card img { width:40px; height:40px; object-fit:contain; }

/* -------- Legend ------- */
.map-legend {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 12px;
}
.legend-item {
  display: flex;
  gap: 10px;
  align-items: center;
  background: #fff;
  border: 1px solid rgba(0,0,0,0.07);
  padding: 10px 12px;
  border-radius: 10px;
  min-width: 180px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.legend-item img {
  width:48px;
  height:48px;
  object-fit:cover;
  border-radius:8px;
}
.legend-text .title { font-weight:700; color:#0c3b66; display:block; }
.legend-text .desc { font-size:12px; color:#556777; margin-top:3px; }
</style>
</head>

<body>

<header>
  <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ - Ù„ÙˆØ­Ø© Ø§Ù„Ø¶ÙŠÙ (<span id="userName"></span>)</h2>
  <button onclick="logout()" style="padding:8px 15px;border:none;border-radius:6px;cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="content">

  <div class="card" id="mapTypesCard">
    <h3>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· (Ù…Ø±Ø¬Ø¹ Ø³Ø±ÙŠØ¹)</h3>
    <p style="margin-top:6px; color:#444;">Ø§Ù„Ø£Ø³ÙÙ„ ÙŠÙˆØ¶Ø­ ØµÙˆØ± ÙˆØ£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© Ù„ØªØ¹Ø±Ù Ù†ÙˆØ¹ ÙƒÙ„ Ø®Ø±ÙŠØ·Ø©.</p>
    <div id="mapLegend" class="map-legend"></div>
  </div>

  <div class="card">
    <h3>Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙˆØ±Ùƒ:</h3>
    <p>Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„ØªÙŠ Ø³Ù…Ø­ Ù„Ùƒ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„ÙŠÙ‡Ø§.</p>
    <div id="guestMaps">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·...</div>
  </div>

</div>

<script>
// ------------------ Ø­Ù…Ø§ÙŠØ© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ------------------
window.onload = async function () {

    const userProfile = await protectPage();
    if (!userProfile) return;

    if (userProfile.role === "admin") return location.href = "dashboard.html";
    if (userProfile.role === "user") return location.href = "user.html";
    if (userProfile.role !== "guest") return logout();

    document.getElementById("userName").innerText = userProfile.email;

    // ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø£Ø¹Ù„Ø§Ù‡
    await renderMapTypesLegend();

    // ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø¶ÙŠÙ
    await renderGuestMaps();
};



// -----------------------------------------------
// ğŸ“Œ 1) Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù€ LEGEND (Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©)
// -----------------------------------------------
async function renderMapTypesLegend() {

    const legend = document.getElementById("mapLegend");
    legend.innerHTML = "";

    const types = [
        { key: "Ø®Ø¯Ù…ÙŠØ©", title: "Ø®Ø¯Ù…ÙŠØ©", desc: "Ù…Ø±Ø§ÙÙ‚ ÙˆØ®Ø¯Ù…Ø§Øª Ø¹Ø§Ù…Ø©" },
        { key: "Ø³ÙƒÙ†ÙŠØ©", title: "Ø³ÙƒÙ†ÙŠØ©", desc: "Ù…Ù†Ø§Ø·Ù‚ ÙˆØ£Ø­ÙŠØ§Ø¡ Ø³ÙƒÙ†ÙŠØ©" },
        { key: "ØªØ¬Ø§Ø±ÙŠØ©", title: "ØªØ¬Ø§Ø±ÙŠØ©", desc: "Ø£Ø³ÙˆØ§Ù‚ ÙˆÙ…Ø­Ù„Ø§Øª ÙˆØ£Ù†Ø´Ø·Ø© ØªØ¬Ø§Ø±ÙŠØ©" },
        { key: "ØµÙ†Ø§Ø¹ÙŠØ©", title: "ØµÙ†Ø§Ø¹ÙŠØ©", desc: "Ù…Ù†Ø´Ø¢Øª ÙˆÙ…Ù†Ø§Ø·Ù‚ ØµÙ†Ø§Ø¹ÙŠØ©" }
    ];

    types.forEach(t => {

        // Ø§Ù„ØµÙˆØ± ØªØ£ØªÙŠ Ù…Ù† Supabase Ø®Ù„Ø§Ù„ window.mapImages
        const src = (window.mapImages && window.mapImages[t.key]) ? window.mapImages[t.key] : "assets/images/default.png";

        const item = document.createElement("div");
        item.className = "legend-item";

        item.innerHTML = `
            <img src="${src}" alt="${t.title}">
            <div class="legend-text">
                <span class="title">${t.title}</span>
                <span class="desc">${t.desc}</span>
            </div>
        `;

        legend.appendChild(item);
    });
}



// -----------------------------------------------
// ğŸ“Œ 2) Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø¶ÙŠÙ Ù…Ù† Supabase
// -----------------------------------------------
async function renderGuestMaps() {

    const mapsContainer = document.getElementById("guestMaps");

    const allMaps = await getAccessibleMaps("guest");

    const accessibleMaps = allMaps.filter(m => m.allowed_roles?.includes("guest"));

    if (accessibleMaps.length === 0) {
        mapsContainer.innerHTML = "<p style='color:#777;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø±Ø§Ø¦Ø· Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
        return;
    }

    mapsContainer.innerHTML = "";

    accessibleMaps.forEach(map => {

        const div = document.createElement("div");
        div.className = "map-card";

        const link = document.createElement("a");
        link.href = map.url;
        link.target = "_blank";

        const imgSrc = map.image_url || (window.mapImages && window.mapImages[map.type]) || "assets/images/default.png";

        link.innerHTML = `
            <img src="${imgSrc}" alt="">
            <span>${map.name}</span>
        `;

        div.appendChild(link);
        mapsContainer.appendChild(div);
    });
}

</script>

</body>
</html>
