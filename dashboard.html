<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - جهاز معلومات شبكات المرافق</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family:sans-serif; direction:rtl; }

/* الهيدر */
header {
  background: linear-gradient(90deg,#00F260,#0575E6);
  color:white;
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position: fixed;
  top:0;
  left:0;
  right:0;
  z-index: 1001;
}
header span { font-weight:bold; }
header a { color:white; text-decoration:none; font-weight:bold; margin-left:15px; z-index:1002; }

/* القائمة الجانبية */
.sidebar {
  width:220px;
  background:#2c3e50;
  color:white;
  position:fixed;
  top:70px;
  left:0;
  height:calc(100% - 70px);
  padding:20px;
  overflow-y:auto;
}
.sidebar a { color:white; text-decoration:none; display:block; margin:12px 0; }
.sidebar a:hover { background:#34495e; padding-left:5px; }

/* المحتوى الرئيسي */
.main-content {
  margin-top: 70px;
  margin-left:240px;
  padding:30px;
}

/* لوحة التحكم للادمن */
#adminControl, #visitsControl, #adminAccounts {
  margin-top:20px;
  padding:10px;
  border:1px solid #ccc;
  background:#f8f8f8;
  border-radius:5px;
}
#adminControl input, #adminAccounts input, #adminAccounts select { width:70%; padding:8px; margin-right:5px; }
#adminControl button, #adminAccounts button { padding:8px; margin-top:5px; cursor:pointer; }

/* بطاقات الصور */
.image-card { display:inline-block; margin:10px; text-align:center; }
.image-card img { width:150px; height:100px; object-fit:cover; display:block; }
.image-card button { margin-top:5px; padding:5px; cursor:pointer; }

/* شارت الزيارات */
#visitsChart { width:100%; max-width:600px; height:300px; }

/* Footer ثابت */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg,#00F260,#0575E6);
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-weight: 700;
  padding: 6px 0;
  z-index: 1000;
}
footer .line2 { font-weight: 600; font-size: 13px; margin-top: 2px; }

#usersList div {
  margin: 5px 0;
  padding: 5px;
  background: #34495e;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#usersList button { padding: 3px 6px; cursor: pointer; }
</style>
</head>
<body>

<header>
  <div>مرحبا، <span id="userName"></span></div>
  <nav>
    <a href="#" id="logoutLink">تسجيل الخروج</a>
  </nav>
</header>

<div class="sidebar">
  <a id="adminMenu" href="#">لوحة التحكم (Admin)</a>
  <a id="userMenu" href="#">صفحات المستخدم</a>
  <a id="guestMenu" href="#">صفحة الضيف</a>
  <a href="Government-Departments-Complex.html">صفحة الخريطة الرئيسية</a>
</div>

<div class="main-content">
  <h2>لوحة التحكم</h2>
  
  <!-- إدارة الصور -->
  <div id="adminControl" style="display:none;">
    <h3>إدارة الصور</h3>
    <input type="text" id="newImageURL" placeholder="رابط الصورة من الإنترنت">
    <input type="file" id="newImageFile" accept="image/*">
    <button id="addImageBtn">إضافة صورة</button>
    <div id="imagesContainer"></div>
  </div>

  <!-- إدارة الحسابات -->
  <div id="adminAccounts" style="display:none;">
    <h3>إدارة الحسابات</h3>
    <input type="text" id="newUsername" placeholder="اسم المستخدم">
    <input type="password" id="newPassword" placeholder="كلمة المرور">
    <select id="newRole">
      <option value="admin">Admin</option>
      <option value="user">User</option>
      <option value="guest">Guest</option>
    </select>
    <button id="addUserBtn">إضافة مستخدم</button>
    <h4>المستخدمون الحاليون</h4>
    <div id="usersList"></div>
  </div>

  <!-- شارت الزيارات -->
<div id="visitsControl" style="display:none;">
  <h3 id="visitsSectionTitle">زيارات المستخدمين</h3>
  <canvas id="visitsChart"></canvas>
</div>

</div>

<footer>
  إعداد جهاز معلومات شبكات المرافق - محافظة الوادي الجديد
  <span class="line2">Designed By Eng. Ahmed Labib </span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/auth.js"></script>
<script>
// ====== بيانات المستخدم ======
let sessionUser = JSON.parse(localStorage.getItem("loggedUser"));
if(!sessionUser){
  alert("يجب تسجيل الدخول أولاً");
  window.location.href = "index.html";
}
document.getElementById("userName").innerText = sessionUser.username;

// ====== المستخدمين الافتراضيين ======
const defaultUsers = [
  { username: "admin", password: "1234", role: "admin" },
  { username: "user1", password: "1111", role: "user" },
  { username: "guest", password: "0000", role: "guest" }
];

const accountsKey = "siteUsers";
if(!localStorage.getItem(accountsKey)){
  localStorage.setItem(accountsKey, JSON.stringify(defaultUsers));
}

// ====== سجل زيارات المستخدمين ======
if(!localStorage.getItem("userVisits")){
  const allUsers = JSON.parse(localStorage.getItem(accountsKey)) || defaultUsers;
  let visits = {};
  allUsers.forEach(u => visits[u.username] = 0);
  localStorage.setItem("userVisits", JSON.stringify(visits));
}

// زيادة عدد زيارات المستخدم الحالي
let allVisits = JSON.parse(localStorage.getItem("userVisits"));
if(allVisits[sessionUser.username] !== undefined){
    allVisits[sessionUser.username] += 1;
}else{
    allVisits[sessionUser.username] = 1; // مستخدم جديد
}
localStorage.setItem("userVisits", JSON.stringify(allVisits));

// ====== التحكم في القوائم حسب الدور ======
if(sessionUser.role === "admin"){
  document.getElementById("adminMenu").style.display = "block";
  document.getElementById("userMenu").style.display = "block";
  document.getElementById("guestMenu").style.display = "block";
  document.getElementById("adminControl").style.display = "block";
  document.getElementById("adminAccounts").style.display = "block";
  document.getElementById("visitsControl").style.display = "block";
}else if(sessionUser.role === "user"){
  document.getElementById("adminMenu").style.display = "none";
  document.getElementById("userMenu").style.display = "block";
  document.getElementById("guestMenu").style.display = "block";
}else{
  document.getElementById("adminMenu").style.display = "none";
  document.getElementById("userMenu").style.display = "none";
  document.getElementById("guestMenu").style.display = "block";
}

// ====== تسجيل الخروج ======
document.getElementById("logoutLink").onclick = function(){
  localStorage.removeItem("loggedUser");
  window.location.href = "index.html";
};

// ====== إعداد GitHub API للصور ======
const token = "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";
const owner = "gisnewvally-eng";
const repo = "test";
const branch = "main";
const folder = "images";

// تحميل الصور
async function loadImages() {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}?ref=${branch}`, {
      headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }
    });
    const files = await res.json();
    const container = document.getElementById("imagesContainer");
    container.innerHTML = "";
    files.forEach(file => {
      const div = document.createElement("div");
      div.className = "image-card";
      div.innerHTML = `<img src="${file.download_url}" alt="">`;
      if(sessionUser.role === "admin"){
        div.innerHTML += `<button onclick="deleteImage('${file.name}')">حذف</button>`;
      }
      container.appendChild(div);
    });
  } catch(err){ console.error(err); }
}
loadImages();

// إضافة صورة
document.getElementById("addImageBtn").onclick = async function(){
  const url = document.getElementById("newImageURL").value;
  const fileInput = document.getElementById("newImageFile");

  if(url){
    const name = url.split("/").pop();
    const content = btoa(await (await fetch(url)).arrayBuffer());
    try {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${name}`, {
        method: "PUT",
        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: `Add image ${name}`, content: content, branch: branch })
      });
      const data = await res.json();
      if(data.content){ document.getElementById("newImageURL").value = ""; loadImages(); }
      else alert("حدث خطأ أثناء الإضافة");
    } catch(err){ console.error(err); }
    return;
  }

  if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    const name = file.name;
    const reader = new FileReader();
    reader.onloadend = async function() {
      const base64Data = reader.result.split(',')[1];
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${name}`, {
          method: "PUT",
          headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
          body: JSON.stringify({ message: `Add image ${name}`, content: base64Data, branch: branch })
        });
        const data = await res.json();
        if(data.content){ fileInput.value = ""; loadImages(); }
        else alert("حدث خطأ أثناء الإضافة");
      } catch(err){ console.error(err); }
    };
    reader.readAsDataURL(file);
    return;
  }
  alert("اختر صورة من الإنترنت أو من جهازك أولاً");
};

// حذف صورة
async function deleteImage(name){
  if(!confirm("هل تريد حذف هذه الصورة؟")) return;
  try {
    const resSha = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${name}?ref=${branch}`, {
      headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }
    });
    const dataSha = await resSha.json();
    if(!dataSha.sha){ alert("الملف غير موجود"); return; }
    const resDel = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${name}`, {
      method: "DELETE",
      headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ message: `Delete image ${name}`, sha: dataSha.sha, branch: branch })
    });
    const dataDel = await resDel.json();
    if(dataDel.commit) loadImages();
    else alert("حدث خطأ أثناء الحذف");
  } catch(err){ console.error(err); }
}

// ====== شارت الزيارات ======
const ctx = document.getElementById('visitsChart').getContext('2d');
const visitsChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'عدد الزيارات',
            data: [],
            backgroundColor: []
        }]
    }
});

function updateVisitsChart() {
    const visitsData = JSON.parse(localStorage.getItem("userVisits")) || {};
    const labels = Object.keys(visitsData);
    const dataValues = Object.values(visitsData);
    visitsChart.data.labels = labels;
    visitsChart.data.datasets[0].data = dataValues;
    visitsChart.data.datasets[0].backgroundColor = labels.map(label => {
        if(label.toLowerCase() === 'admin') return '#004b8d';
        if(label.toLowerCase() === 'guest') return '#96c93d';
        return '#2c3e50';
    });
    visitsChart.update();
}
updateVisitsChart();

// ====== إدارة الحسابات ======

// تحميل وعرض المستخدمين
function loadUsers() {
  const userListDiv = document.getElementById("usersList");
  const allUsers = JSON.parse(localStorage.getItem(accountsKey));
  userListDiv.innerHTML = "";
  allUsers.forEach((u, index) => {
    const div = document.createElement("div");
    div.innerHTML = `
      ${u.username} (${u.role})
      <span>
        <button onclick="deleteUser(${index})">حذف</button>
        <button onclick="changePassword(${index})">تغيير كلمة المرور</button>
      </span>
    `;
    userListDiv.appendChild(div);
  });
}
loadUsers();

// إضافة مستخدم جديد
document.getElementById("addUserBtn").onclick = function(){
  const username = document.getElementById("newUsername").value.trim();
  const password = document.getElementById("newPassword").value;
  const role = document.getElementById("newRole").value;

  if(!username || !password){ alert("املأ جميع الحقول"); return; }

  const allUsers = JSON.parse(localStorage.getItem(accountsKey));
  if(allUsers.find(u=>u.username===username)){ alert("اسم المستخدم موجود مسبقاً"); return; }

  allUsers.push({username, password, role});
  localStorage.setItem(accountsKey, JSON.stringify(allUsers));

  // إضافة سجل زيارات جديد
  let visits = JSON.parse(localStorage.getItem("userVisits")) || {};
  visits[username] = 0;
  localStorage.setItem("userVisits", JSON.stringify(visits));

  document.getElementById("newUsername").value = "";
  document.getElementById("newPassword").value = "";

  loadUsers();
  updateVisitsChart();
};

// حذف مستخدم
function deleteUser(index){
  if(!confirm("هل تريد حذف هذا المستخدم؟")) return;
  const allUsers = JSON.parse(localStorage.getItem(accountsKey));
  const usernameToDelete = allUsers[index].username;

  allUsers.splice(index,1);
  localStorage.setItem(accountsKey, JSON.stringify(allUsers));

  // حذف سجل زيارات المستخدم
  let visits = JSON.parse(localStorage.getItem("userVisits")) || {};
  delete visits[usernameToDelete];
  localStorage.setItem("userVisits", JSON.stringify(visits));

  loadUsers();
  updateVisitsChart();
}

// تغيير كلمة المرور
function changePassword(index){
  const allUsers = JSON.parse(localStorage.getItem(accountsKey));
  const newPass = prompt("ادخل كلمة المرور الجديدة:", allUsers[index].password);
  if(newPass){
    allUsers[index].password = newPass;
    localStorage.setItem(accountsKey, JSON.stringify(allUsers));
    loadUsers();
  }
}

</script>

</body>
</html>

