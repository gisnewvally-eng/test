<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - ุฌูุงุฒ ูุนูููุงุช ุดุจูุงุช ุงููุฑุงูู</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
/* =======================
   ููุฏุฑ ุซุงุจุช ููุชูุงุณู
======================= */
header {
  background: linear-gradient(90deg,#00F260,#0575E6);
  color: white;
  padding: 15px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1001;
  flex-wrap: wrap; /* ูุชุฌูุจ ุงูุชูุฏุณ ุนูู ุดุงุดุงุช ุตุบูุฑุฉ */
}

/* ุงููุต ูู ุงูููุฏุฑ */
header span { font-weight: bold; font-size: 1rem; }
header a { color: white; text-decoration: none; font-weight: bold; margin-left: 15px; }

/* ุงููุณู ุงูุฃููู ูุงููุณุงุฑ */
header > div:first-child { order: 2; margin-left: auto; } /* ุงุณู ุงููุณุชุฎุฏู ุนูู ุงููููู */
header nav { order: 1; } /* ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ุนูู ุงููุณุงุฑ */

/* ุฒุฑ Sidebar */
#toggleSidebar {
  position: fixed;
  top: 80px;
  left: 0;
  width: 30px;
  height: 30px;
  background: #1a2980;
  color: white;
  font-size: 24px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 0 5px 5px 0;
  cursor: pointer;
  z-index: 1100;
  transition: background 0.3s;
}
#toggleSidebar:hover { background: #26d0ce; }

/* Sidebar */
.sidebar {
  width: 220px;
  background: #2c3e50;
  color: white;
  position: fixed;
  top: 70px;
  left: 0;
  height: calc(100% - 70px);
  padding: 20px;
  overflow-y: auto;
  transition: transform 0.3s ease;
}
.sidebar.hidden { transform: translateX(-250px); }
.sidebar a {
  color: white;
  text-decoration: none;
  display: block;
  margin: 12px 0;
  padding: 5px;
  transition: padding-left 0.3s, background 0.3s;
}
.sidebar a:hover { background:#34495e; padding-left:10px; }

/* ุงููุญุชูู ุงูุฑุฆูุณู */
.main-content {
  margin-top: 70px;
  margin-left: 240px;
  padding: 30px;
  padding-bottom: 60px;
  transition: margin-left 0.3s;
}

/* Footer */
footer {
  position: fixed;
  bottom:0;
  left:0;
  right:0;
  background: linear-gradient(90deg,#00F260,#0575E6);
  color:#fff;
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-weight:700;
  padding:6px 0;
  z-index:1000;
}
footer .line2 { font-weight:600; font-size:13px; margin-top:2px; }

/* =======================
   ูุชุฌุงูุจ
======================= */
@media (max-width: 1024px) {
  .main-content { margin-left: 220px; padding: 20px; }
}

@media (max-width: 768px) {
  header { flex-direction: column; align-items: flex-start; padding: 10px 15px; }
  header > div:first-child { margin-left: 0; order: 1; }
  header nav { order: 2; margin-top: 5px; }
  
  .main-content { margin-left: 0; padding: 15px; }
  .sidebar { width: 200px; top: 70px; height: calc(100% - 70px); }
  #toggleSidebar { top: 70px; }
}

@media (max-width: 480px) {
  header { padding: 8px 10px; }
  header span { font-size: 0.9rem; }
  .sidebar { width: 180px; padding: 15px; }
  .main-content { padding: 10px; }
  #toggleSidebar { width: 28px; height: 28px; font-size: 20px; top: 70px; }
}

</style>
</head>
<body>

<header>
ย <div>ูุฑุญุจุงุ <span id="userName"></span></div>
ย <nav><a href="#" id="logoutLink">ุชุณุฌูู ุงูุฎุฑูุฌ</a></nav>
</header>
ยย
<div id="toggleSidebar" style="
ย ย position: fixed;
ย ย top: 80px;ย ย ย ย
ย ย left: 0;
ย ย width: 30px;
ย ย height: 30px;
ย ย background: #1a2980;
ย ย color: white;
ย ย font-size: 24px;
ย ย display: flex;
ย ย justify-content: center;
ย ย align-items: center;
ย ย border-radius: 0 5px 5px 0;
ย ย cursor: pointer;
ย ย z-index: 1100;">
ย ย &#9776;
</div>

<div class="sidebar">
ย <h4>ูุงุฆูุฉ ุงูุฃุฏูู</h4>
ย <a id="managePagesMenu" href="manage-pages.html">ุฅุฏุงุฑุฉ ุงูุฎุฑุงุฆุท</a>
ย ย <div id="dynamicMapsLinks"></div>
</div>

<div class="main-content">
ย <h2>ููุญุฉ ุชุญูู ุงููุณุคูู (Admin)</h2>

ย <div id="adminAccounts" class="admin-section">
ย ย <h3>ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช</h3>
ย ย <input type="email" id="newUserEmail" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุงุณู ุงููุณุชุฎุฏู)">
ย ย <input type="password" id="newPassword" placeholder="ูููุฉ ุงููุฑูุฑ">
ย ย <select id="newRole">
ย ย ย <option value="admin">Admin</option>
ย ย ย <option value="user">User</option>
ย ย ย <option value="guest">Guest</option>
ย ย </select>
ย ย <button id="addUserBtn">ุฅุถุงูุฉ ูุณุชุฎุฏู</button>
ย ย <h4>ุงููุณุชุฎุฏููู ุงูุญุงูููู</h4>
ย ย <div id="usersList">ุฌุงุฑู ุชุญููู ุงููุณุชุฎุฏููู...</div>
ย </div>

ย <div id="visitsControl" class="admin-section">
ย ย <h3>ุฒูุงุฑุงุช ุงููุณุชุฎุฏููู</h3>
ย ย <canvas id="visitsChart"></canvas>
ย </div>
</div>

<footer>
ย ุฅุนุฏุงุฏ ุฌูุงุฒ ูุนูููุงุช ุดุจูุงุช ุงููุฑุงูู - ูุญุงูุธุฉ ุงููุงุฏู ุงูุฌุฏูุฏ
ย <span class="line2">Designed By Eng. Ahmed Labib </span>
</footer>

<script>
    // ------------------ 1. ุชุนุฑูู Chart.js ------------------
    let visitsChart;

    // ------------------ 2. ุฏุงูุฉ ุชุญุฏูุซ ุงูุดุงุฑุช ูู Supabase ------------------
    async function updateVisitsChart(){
        const stats = await getVisitStats(); // ุฏุงูุฉ ูู auth.js
        if (!stats) return;

        const roles = Object.keys(stats);
        const counts = Object.values(stats);

        if (!visitsChart) {
            const ctx = document.getElementById('visitsChart').getContext('2d');
            visitsChart = new Chart(ctx, {
                type:'bar',
                data:{
                    labels: roles,
                    datasets:[{
                        label:'ุนุฏุฏ ุงูุฒูุงุฑุงุช',
                        data: counts,
                        backgroundColor: roles.map(r => {
                            if(r.toLowerCase()==='admin') return '#004b8d';
                            if(r.toLowerCase()==='guest') return '#96c93d';
                            return '#2c3e50';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        } else {
            visitsChart.data.labels = roles;
            visitsChart.data.datasets[0].data = counts;
            visitsChart.update();
        }
    }

    // ------------------ 3. ุฏุงูุฉ ุฅุถุงูุฉ ุฎุฑูุทุฉ ููู Sidebar ------------------
    async function loadDynamicMaps(role) {
        const mapsContainer = document.getElementById("dynamicMapsLinks");
        mapsContainer.innerHTML = "";
        
        // ุงุณุชุฎุฏุงู ุฏุงูุฉ ุฌูุจ ุงูุฎุฑุงุฆุท ูู auth.js ูุฏูุฑ ุงูุฃุฏูู
        const accessibleMaps = await getAccessibleMaps(role); 

        accessibleMaps.forEach(map => {
            const a = document.createElement("a");
            a.href = map.url;
            a.textContent = map.name;
            a.target = "_blank"; 
            mapsContainer.appendChild(a);
        });
    }

    // ------------------ 4. ููุทู ุชุญููู ูุญูุงูุฉ ุงูุตูุญุฉ ------------------
    window.onload = async function() {
        
        // ๐ก๏ธ ุญูุงูุฉ ุงูุตูุญุฉ ูุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู
        const userProfile = await protectPage(); // ุฏุงูุฉ ูู auth.js
        
        if(!userProfile){
            window.location.href = "index.html";
            return;
        }

        // โ๏ธ ุงูุชุญูู ูู ุงูุฏูุฑ (ูุฌุจ ุฃู ูููู Admin)
        if(userProfile.role !== "admin"){
            alert("ููุณ ูุฏูู ุตูุงุญูุฉ ุงููุตูู ููุฐู ุงูุตูุญุฉุ ุณูุชู ุชูุฌููู.");
            if(userProfile.role === "user") window.location.href = "user.html";
            else if(userProfile.role === "guest") window.location.href = "guest.html";
            else logout();
            return;
        }

        // ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู
        document.getElementById("userName").innerText = userProfile.email;

        // ุนุฑุถ ุฃูุณุงู Admin
        ["adminAccounts","visitsControl"].forEach(id=>{
            const el = document.getElementById(id);
            if(el) el.style.display = "block";
        });
        
        // ุชุญููู ูุงุฆูุฉ ุงููุณุชุฎุฏููู (ุฏุงูุฉ ูู auth.js)
        await loadUsersList(); 
        
        // ุชุญููู ุดุงุฑุช ุงูุฒูุงุฑุงุช
        await updateVisitsChart(); 
        
        // ุชุญููู ุฎุฑุงุฆุท Sidebar
        await loadDynamicMaps(userProfile.role);

        // Sidebar toggle
        const toggleBtn = document.getElementById("toggleSidebar");
        const sidebar = document.querySelector(".sidebar");
        toggleBtn.onclick = function() {
            sidebar.classList.toggle("hidden"); 
            toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;";
        };

        // ===== ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ =====
        document.getElementById("addUserBtn").onclick = async function() {
    const name = document.getElementById("newUserName").value.trim(); // ุงุณู ุงููุณุชุฎุฏู
    const email = document.getElementById("newUserEmail").value.trim();
    const password = document.getElementById("newPassword").value;
    const role = document.getElementById("newRole").value;

    if(!name || !email || !password){ 
        alert("ุงููุฃ ุฌููุน ุงูุญููู"); 
        return; 
    }
    
    // ๐ ุงุณุชุฎุฏุงู ุฏุงูุฉ addUser ูู auth.js ูุน ุงูุงุณู ุงูุฌุฏูุฏ
    const success = await addUser(name, email, password, role); 

    if(success){
        alert("ุชู ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุจูุฌุงุญ!");
        document.getElementById("newUserName").value = "";
        document.getElementById("newUserEmail").value = "";
        document.getElementById("newPassword").value = "";
        await loadUsersList(); // ุฅุนุงุฏุฉ ุชุญููู ุงููุงุฆูุฉ
        await updateVisitsChart(); // ุชุญุฏูุซ ุงูุดุงุฑุช
    }
};


        // ===== ุชุณุฌูู ุงูุฎุฑูุฌ =====
        document.getElementById("logoutLink").onclick = (e) => { 
            e.preventDefault();
            logout(); 
        };
        
        // ===== ุฏูุงู ุงูุญุฐู ูุงูุชุนุฏูู ุนูู ุงููุณุชุฎุฏููู (ุชุณุชุฎุฏู ุฏุงูุฉ deleteUser ูู auth.js) =====
        // ูุชู ุชุนุฑูู ุงูุฏูุงู ุจุดูู ุนุงู (window.deleteUser) ูุงุณุชุฏุนุงุฆูุง ูู HTML ูู ุฏุงูุฉ loadUsersList ุจู auth.js 
        // โ๏ธ ููุงุญุธุฉ: ุชู ุชุนุฏูู ุฏุงูุฉ deleteUser ูู auth.js ูุชุนูู ุนูู ุงูู ID ุจุฏูุงู ูู ุงูู index.
        window.deleteUser = async function(userId){
            if(!confirm("ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุณุชุฎุฏู ููุงุฆูุงูุ")) return;
            await deleteUser(userId);
            await loadUsersList(); // ุฅุนุงุฏุฉ ุชุญููู ุงููุงุฆูุฉ
            await updateVisitsChart(); // ุชุญุฏูุซ ุงูุดุงุฑุช
        }
        
        // โ๏ธ ููุงุญุธุฉ: ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุนุจุฑ ุงูู Front-end ูุจุงุดุฑุฉ ูุชุทูุจ ุตูุงุญูุงุช Admin APIุ 
        // ููุชุจุณูุท ุงููุดุฑูุนุ ุณูุฒูู ุฒุฑ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ููุฑูุฒ ุนูู ุงูุฅุถุงูุฉ ูุงูุญุฐู.
    };
</script>
</body>
</html>

