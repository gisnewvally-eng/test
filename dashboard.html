<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - جهاز معلومات شبكات المرافق</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
/* =======================
   هيدر ثابت ومتناسق
======================= */
header {
  background: linear-gradient(90deg,#00F260,#0575E6);
  color: white;
  padding: 15px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1001;
  flex-wrap: wrap;
}

header span { font-weight: bold; font-size: 1rem; }
header nav { order: 1; margin-left: 0; }  /* زر تسجيل الخروج أقصى اليسار */
header > div:first-child { order: 2; margin-left: auto; } /* اسم المستخدم على اليمين */
header a { color: white; text-decoration: none; font-weight: bold; margin-left: 15px; }

/* زر Sidebar */
#toggleSidebar {
  position: fixed;
  top: 80px;
  left: 0;
  width: 30px;
  height: 30px;
  background: #1a2980;
  color: white;
  font-size: 24px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 0 5px 5px 0;
  cursor: pointer;
  z-index: 1100;
  transition: background 0.3s;
}
#toggleSidebar:hover { background: #26d0ce; }

/* Sidebar */
.sidebar {
  width: 220px;
  background: #2c3e50;
  color: white;
  position: fixed;
  top: 70px;
  left: 0;
  height: calc(100% - 70px);
  padding: 20px;
  overflow-y: auto;
  transition: transform 0.3s ease;
}
.sidebar.hidden { transform: translateX(-250px); }
.sidebar a {
  color: white;
  text-decoration: none;
  display: block;
  margin: 12px 0;
  padding: 5px;
  transition: padding-left 0.3s, background 0.3s;
}
.sidebar a:hover { background:#34495e; padding-left:10px; }

/* المحتوى الرئيسي */
.main-content {
  margin-top: 70px;
  margin-left: 240px;
  padding: 30px;
  padding-bottom: 60px;
  transition: margin-left 0.3s;
}

/* Footer */
footer {
  position: fixed;
  bottom:0;
  left:0;
  right:0;
  background: linear-gradient(90deg,#00F260,#0575E6);
  color:#fff;
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-weight:700;
  padding:6px 0;
  z-index:1000;
}
footer .line2 { font-weight:600; font-size:13px; margin-top:2px; }

/* =======================
   متجاوب
======================= */
@media (max-width: 1024px) {
  .main-content { margin-left: 220px; padding: 20px; }
}
@media (max-width: 768px) {
  header { flex-direction: column; align-items: flex-start; padding: 10px 15px; }
  header > div:first-child { margin-left: 0; order: 1; }
  header nav { order: 2; margin-top: 5px; }
  .main-content { margin-left: 0; padding: 15px; }
  .sidebar { width: 200px; top: 70px; height: calc(100% - 70px); }
  #toggleSidebar { top: 70px; }
}
@media (max-width: 480px) {
  header { padding: 8px 10px; }
  header span { font-size: 0.9rem; }
  .sidebar { width: 180px; padding: 15px; }
  .main-content { padding: 10px; }
  #toggleSidebar { width: 28px; height: 28px; font-size: 20px; top: 70px; }
}
</style>
</head>
<body>

<header>
  <nav><a href="#" id="logoutLink">تسجيل الخروج</a></nav>
  <div>مرحبا، <span id="userName"></span></div>
</header>
  
<div id="toggleSidebar">&#9776;</div>

<div class="sidebar">
  <h4>قائمة الأدمن</h4>
  <a id="managePagesMenu" href="manage-pages.html">إدارة الخرائط</a>
  <div id="dynamicMapsLinks"></div>
</div>

<div class="main-content">
  <h2>لوحة تحكم المسؤول (Admin)</h2>

  <div id="adminAccounts" class="admin-section">
    <h3>إدارة الحسابات</h3>
    <input type="text" id="newUserName" placeholder="اسم المستخدم">
    <input type="email" id="newUserEmail" placeholder="البريد الإلكتروني">
    <input type="password" id="newPassword" placeholder="كلمة المرور">
    <select id="newRole">
      <option value="admin">Admin</option>
      <option value="user">User</option>
      <option value="guest">Guest</option>
    </select>
    <button id="addUserBtn">إضافة مستخدم</button>
    <h4>المستخدمون الحاليون</h4>
    <div id="usersList">جاري تحميل المستخدمين...</div>
  </div>

  <div id="visitsControl" class="admin-section">
    <h3>زيارات المستخدمين</h3>
    <canvas id="visitsChart"></canvas>
  </div>
</div>

<footer>
  إعداد جهاز معلومات شبكات المرافق - محافظة الوادي الجديد
  <span class="line2">Designed By Eng. Ahmed Labib </span>
</footer>

<script>
let visitsChart;

// تحديث شارت الزيارات
async function updateVisitsChart(){
    const stats = await getVisitStats();
    if (!stats) return;

    const roles = Object.keys(stats);
    const counts = Object.values(stats);

    if (!visitsChart) {
        const ctx = document.getElementById('visitsChart').getContext('2d');
        visitsChart = new Chart(ctx, {
            type:'bar',
            data:{
                labels: roles,
                datasets:[{
                    label:'عدد الزيارات',
                    data: counts,
                    backgroundColor: roles.map(r => {
                        if(r.toLowerCase()==='admin') return '#004b8d';
                        if(r.toLowerCase()==='guest') return '#96c93d';
                        return '#2c3e50';
                    })
                }]
            },
            options: { responsive:true, maintainAspectRatio:false }
        });
    } else {
        visitsChart.data.labels = roles;
        visitsChart.data.datasets[0].data = counts;
        visitsChart.update();
    }
}

// تحميل خرائط Sidebar
async function loadDynamicMaps(role) {
    const mapsContainer = document.getElementById("dynamicMapsLinks");
    mapsContainer.innerHTML = "";
    const accessibleMaps = await getAccessibleMaps(role); 
    accessibleMaps.forEach(map => {
        const a = document.createElement("a");
        a.href = map.url;
        a.textContent = map.name;
        a.target = "_blank"; 
        mapsContainer.appendChild(a);
    });
}

// تحميل وحماية الصفحة
window.onload = async function() {
    const userProfile = await protectPage();
    if(!userProfile){ window.location.href="index.html"; return; }

    if(userProfile.role !== "admin"){
        alert("ليس لديك صلاحية الوصول لهذه الصفحة، سيتم توجيهك.");
        if(userProfile.role==="user") window.location.href="user.html";
        else if(userProfile.role==="guest") window.location.href="guest.html";
        else logout();
        return;
    }

    document.getElementById("userName").innerText = userProfile.name || userProfile.email;

    ["adminAccounts","visitsControl"].forEach(id=> {
        const el=document.getElementById(id);
        if(el) el.style.display="block";
    });

    await loadUsersList(); 
    await updateVisitsChart(); 
    await loadDynamicMaps(userProfile.role);

    const toggleBtn = document.getElementById("toggleSidebar");
    const sidebar = document.querySelector(".sidebar");
    toggleBtn.onclick = function() {
        sidebar.classList.toggle("hidden"); 
        toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;";
    };

    // إضافة مستخدم جديد
    document.getElementById("addUserBtn").onclick = async function() {
        const name = document.getElementById("newUserName").value.trim();
        const email = document.getElementById("newUserEmail").value.trim();
        const password = document.getElementById("newPassword").value;
        const role = document.getElementById("newRole").value;

        if(!name || !email || !password){ alert("املأ جميع الحقول"); return; }

        const success = await addUser(name, email, password, role); 

        if(success){
            alert("تم إضافة المستخدم بنجاح!");
            document.getElementById("newUserName").value="";
            document.getElementById("newUserEmail").value="";
            document.getElementById("newPassword").value="";
            await loadUsersList(); 
            await updateVisitsChart(); 
        }
    };

    // تسجيل الخروج
    document.getElementById("logoutLink").onclick = (e)=>{ e.preventDefault(); logout(); };

    // دالة حذف المستخدم
    window.deleteUser = async function(userId){
        if(!confirm("هل تريد حذف هذا المستخدم نهائياً؟")) return;
        await deleteUser(userId);
        await loadUsersList(); 
        await updateVisitsChart(); 
    }
};
</script>
</body>
</html>
