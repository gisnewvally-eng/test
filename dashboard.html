<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة الإدارة - جهاز معلومات شبكات المرافق</title>
<link rel="icon" type="image/png" href="assets/images/logo.png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/auth.js"></script>

<style>
/* ================== الهيدر ================== */
body { margin:0; font-family:"Cairo",sans-serif; background:#f5f5f5; }
header {
  background: linear-gradient(90deg,#00F260,#0575E6);
  color:white; padding:15px 25px;
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
  position:fixed; top:0; left:0; right:0; z-index:1001;
}
header span { font-weight:bold; font-size:1rem; }
header nav a { color:white; text-decoration:none; font-weight:bold; margin-left:15px; }

/* ================== Sidebar ================== */
#toggleSidebar {
  position:fixed; top:80px; left:0; width:30px; height:30px;
  background:#1a2980; color:white; font-size:24px;
  display:flex; justify-content:center; align-items:center;
  border-radius:0 5px 5px 0; cursor:pointer; z-index:1100; transition:0.3s;
}
#toggleSidebar:hover { background:#26d0ce; }

.sidebar {
  width:220px; background:#2c3e50; color:white;
  position:fixed; top:70px; left:0; height:calc(100% - 70px);
  padding:20px; overflow-y:auto; transition:transform 0.3s ease;
}
.sidebar.hidden { transform:translateX(-250px); }
.sidebar a { color:white; text-decoration:none; display:block; margin:12px 0; padding:5px; transition:0.3s; border-radius:4px; }
.sidebar a:hover { background:#34495e; padding-left:10px; }

/* ================== Main Content ================== */
.main-content { margin-top:70px; margin-left:240px; padding:30px; padding-bottom:60px; transition:0.3s; }
.admin-section { margin-bottom:40px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

/* ================== Footer ================== */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg,#00F260,#0575E6);
  color: #fff;
  font-weight: 700;
  padding: 6px 0;
  z-index: 1000;
  /* لتوسيط النص سطريًا وعموديًا */
  display: flex;
  align-items: center;    /* توسيط عمودي */
  justify-content: center; /* توسيط أفقي */
  text-align: center;
}
/* ================== Users Table ================== */
table { width:100%; border-collapse:collapse; margin-top:10px; }
table th, table td { padding:10px; text-align:right; border-bottom:1px solid #ccc; font-size:14px; }
table th { background:#00a86b; color:white; }
table tr:hover { background:#f2f2f2; }
button { padding:5px 10px; margin:2px; border:none; border-radius:4px; cursor:pointer; transition:0.3s; font-size:13px; }
button.save { background:#004b8d; color:white; }
button.delete { background:#e74c3c; color:white; }
button.save:hover { background:#002f5a; }
button.delete:hover { background:#c0392b; }

/* ================== Inputs ================== */
input, select { padding:6px; margin:2px; border:1px solid #ccc; border-radius:4px; }

/* ================== Chart ================== */
#visitsChart { height:200px !important; max-width:100%; }

/* ================== Responsive ================== */
/* ================== Responsive - الهواتف ================== */
@media (max-width:768px) {
  /* Main Content */
  .main-content { 
    padding:10px; /* تقليل البادينج */
  }
  .admin-section { 
    margin-bottom:20px; /* تقليل الفراغ */
    padding:8px; /* تصغير البادينج */
  }

  /* Sidebar */
  .sidebar { 
    width:180px; 
    padding:10px; 
  }
  #toggleSidebar { 
    top:70px; 
    width:38px; height:38px; /* تكبير الزر قليلًا ليكون أوضح للموبايل */
    font-size:26px; 
  }

  /* الجداول */
  table th { padding:5px; font-size:12px; }
  button { padding:3px 6px; font-size:12px; }

  /* Inputs */
  input, select { padding:3px; font-size:12px; }

  /* Chart */
  #visitsChart { height:160px !important; }
}

@media (max-width:480px) {
  /* Main Content */
  .main-content { 
    padding:8px; 
  }
  .admin-section { 
    margin-bottom:15px; 
    padding:6px; 
  }

  /* Sidebar */
  .sidebar { 
    width:160px; 
    padding:8px; 
  }
  #toggleSidebar { 
    width:36px; height:36px; font-size:24px; 
  }

  /* الجداول */
  table th, table td { padding:4px; font-size:11px; }
  button { padding:2px 5px; font-size:11px; }

  /* Inputs */
  input, select { padding:2px; font-size:11px; }

  /* Chart */
  #visitsChart { height:140px !important; }
}
@media (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }
  table thead {
    display: none; /* إخفاء رؤوس الجدول */
  }
  table tr {
    margin-bottom: 15px;
    padding: 0;
    border: 1px solid #ccc; /* حد كامل لكل صف */
    border-radius: 8px;
    background: #fff;
    box-sizing: border-box;
  }
  table td {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    padding: 8px 10px;
    font-size: 13px;
    border: none; /* إزالة الحد الافتراضي */
  }
  /* السطر الأول: الاسم والبريد */
  table td:nth-child(1),
  table td:nth-child(2) {
    flex: 1 1 45%;
    margin-bottom: 5px;
  }
  /* السطر الثاني: الدور والأزرار */
  table td:nth-child(3),
  table td:nth-child(4) {
    flex: 1 1 45%;
  }
  table td select {
    width: 100%;
    margin-bottom: 5px;
  }
  table td button {
    flex: 1 1 48%;
    margin-bottom: 5px;
  }
}
</style>
</head>
<body>

<header>
  <div>مرحبا، <span id="userName"></span></div>
  <nav><a href="#" id="logoutLink">تسجيل الخروج</a></nav>
</header>

<div id="toggleSidebar">&#9776;</div>

<div class="sidebar">
  <h4>قائمة الأدمن</h4>
  <a href="manage-pages.html">إدارة الخرائط</a>
  <div id="dynamicMapsLinks"></div>
</div>

<div class="main-content">
  <h2>لوحة تحكم المسؤول</h2>

  <!-- إدارة المستخدمين -->
  <div id="adminAccounts" class="admin-section">
    <h3>إدارة الحسابات</h3>
    <div style="display:flex; flex-wrap:wrap; gap:5px;">
      <input type="text" id="newUserName" placeholder="اسم المستخدم">
      <input type="email" id="newUserEmail" placeholder="البريد الإلكتروني">
      <input type="password" id="newPassword" placeholder="كلمة المرور">
      <select id="newRole">
        <option value="admin">Admin</option>
        <option value="user">User</option>
        <option value="guest">Guest</option>
      </select>
      <button id="addUserBtn" class="save">إضافة مستخدم</button>
    </div>
    <div id="usersList" style="margin-top:10px;">جاري تحميل المستخدمين...</div>
  </div>

  <!-- شارت الزيارات -->
  <div id="visitsControl" class="admin-section">
    <h3>زيارات المستخدمين</h3>
    <canvas id="visitsChart"></canvas>
  </div>
</div>

<footer>
  إعداد جهاز معلومات شبكات المرافق - محافظة الوادي الجديد
</footer>
<script>

// ===========================
// تحميل الصفحة وحماية الوصول
// ===========================
window.onload = async function(){
  const userProfile = await protectPage();
  if(!userProfile){ window.location.href="index.html"; return; }
  if(userProfile.role !== "admin"){ alert("ليس لديك صلاحية الوصول"); window.location.href="index.html"; return; }

  document.getElementById("userName").innerText = userProfile.name || userProfile.email;

  // Sidebar الخرائط
  const maps = await getAccessibleMaps(userProfile.role);
  const mapsContainer = document.getElementById("dynamicMapsLinks");
  mapsContainer.innerHTML = '';
  if(maps.length === 0){ mapsContainer.innerText = 'لا توجد خرائط متاحة'; }
  else{
    maps.forEach(m=>{
      const a = document.createElement('a');
      a.href = m.url || '#';
      a.target = "_blank";
      a.textContent = m.name;
      mapsContainer.appendChild(a);
    });
  }

  await loadUsersList();
  await updateVisitsChart();

  // Sidebar toggle
  const toggleBtn = document.getElementById("toggleSidebar");
  const sidebar = document.querySelector(".sidebar");
  toggleBtn.onclick = ()=>{ 
    sidebar.classList.toggle("hidden"); 
    toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;"; 
  };

  document.getElementById("addUserBtn").onclick = async function(){
  const name = document.getElementById("newUserName").value.trim();
  const email = document.getElementById("newUserEmail").value.trim();
  const password = document.getElementById("newPassword").value;
  const role = document.getElementById("newRole").value;

  if(!name || !email || !password){ alert("املأ جميع الحقول"); return; }

  const success = await addUser(name,email,password,role); // من users.js
  if(success){
    alert("تم إضافة المستخدم");
    await loadUsersList();
  } else {
    alert("حدث خطأ أثناء الإضافة");
  }
};

  document.getElementById("logoutLink").onclick = e=>{ e.preventDefault(); logout(); };
};

// ===========================
// إدارة المستخدمين
// ===========================
async function loadUsersList(){
  const container = document.getElementById("usersList");
  container.innerHTML = "جاري التحميل...";
  
  const users = await getUsers(); // دالة من users.js
  if(!users || users.length===0){ container.innerHTML="لا يوجد مستخدمين"; return; }

  let html = `<table>
    <thead><tr><th>الاسم</th><th>البريد الإلكتروني</th><th>الدور</th><th>إجراء</th></tr></thead><tbody>`;

  users.forEach(u=>{
    html+=`<tr>
      <td>${u.name || u.username}</td>
      <td>${u.email || u.username}</td> <!-- عرض البريد -->
      <td>
        <select onchange="updateUserRole('${u.id}',this.value)">
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
          <option value="user" ${u.role==='user'?'selected':''}>User</option>
          <option value="guest" ${u.role==='guest'?'selected':''}>Guest</option>
        </select>
      </td>
      <td>
        <button class="save" onclick="promptUpdatePassword('${u.id}')">تغيير كلمة السر</button>
        <button class="delete" onclick="confirmDeleteUser('${u.id}')">حذف</button>
      </td>
    </tr>`;
  });

  html+="</tbody></table>";
  container.innerHTML = html;
}
async function promptUpdatePassword(id){
  const pwd = prompt("أدخل كلمة السر الجديدة:");
  if(!pwd) return;
  const success = await updateUserPassword(id, pwd); // users.js
  if(success) alert("تم تغيير كلمة السر بنجاح");
}

async function confirmDeleteUser(id){
  if(!confirm("هل تريد حذف المستخدم؟")) return;
  const success = await deleteUser(id); // users.js
  if(success) alert("تم حذف المستخدم بنجاح");
  await loadUsersList();
}


// ===========================
// شارت الزيارات

// متغير الشارت
let visitsChart;

// دالة جلب إحصائيات الزيارات لكل مستخدم
// ===========================
async function getUsersVisits() {
  try {
    const resUsers = await fetch('/api/users?action=get-users');
    const usersData = await resUsers.json();
    if (!usersData.users) return [];

    const users = usersData.users;

    const resVisits = await fetch('/api/visits?action=get-visits');
    const visitsData = await resVisits.json();
    if (!visitsData.visits) return [];

    const visits = visitsData.visits;

    // معالجة البيانات لكل مستخدم
    const stats = users.map(u => {
      const userVisits = visits.filter(v => v.user_id === u.id);
      const lastVisit = userVisits.length
        ? new Date(Math.max(...userVisits.map(v => new Date(v.visit_time))))
        : null;

      return {
        id: u.id,
        name: u.name || u.username,
        visits: userVisits.length,
        lastVisit: lastVisit ? lastVisit.toLocaleString('ar-EG') : 'لا يوجد زيارات'
      };
    });

    return stats;
  } catch (err) {
    console.error(err);
    return [];
  }
}



// ===========================
// تحديث شارت الزيارات (نسخة محسّنة)
// ===========================
async function updateVisitsChart() {
  const usersVisits = await getUsersVisits();
  if (!usersVisits || usersVisits.length === 0) return;

  const labels = usersVisits.map(u => u.name);
  const data = usersVisits.map(u => u.visits);
  const lastVisits = usersVisits.map(u => u.lastVisit);

  // توليد ألوان مختلفة لكل عمود
  const backgroundColors = usersVisits.map(() =>
    `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`
  );

  const ctx = document.getElementById('visitsChart').getContext('2d');
  
  // إذا كان الشارت موجود مسبقًا، دمره قبل الإنشاء الجديد
  if (visitsChart) visitsChart.destroy();

  visitsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'عدد الزيارات',
        data,
        backgroundColor: backgroundColors,
        hoverBackgroundColor: backgroundColors.map(c => c.replace('50%', '70%')) // لون أعمدة عند hover
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          enabled: true,
          callbacks: {
            label: function(context) {
              const index = context.dataIndex;
              return `زيارات: ${data[index]} | آخر زيارة: ${lastVisits[index]}`;
            }
          }
        }
      },
      interaction: {
        mode: 'index',  // hover يظهر على كل الأعمدة
        intersect: false
      },
      scales: {
        y: { beginAtZero: true },
        x: { ticks: { autoSkip: false } } // لمنع اختفاء أسماء المستخدمين
      }
    }
  });
}

// تحديث تلقائي كل 30 ثانية
setInterval(updateVisitsChart, 30000);


// تحديث عند تحميل الصفحة
window.addEventListener('load', updateVisitsChart);

</script>

</body>
</html>









