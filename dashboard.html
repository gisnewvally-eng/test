<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - جهاز معلومات شبكات المرافق</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/auth.js"></script>
<style>
body { margin:0; font-family:sans-serif; direction:rtl; }
/* Header */
header { background: linear-gradient(90deg,#00F260,#0575E6); color:white; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; position: fixed; top:0; left:0; right:0; z-index:1001; }
header span { font-weight:bold; }
header a { color:white; text-decoration:none; font-weight:bold; margin-left:15px; }

  /* sidebar humbarger */
#toggleSidebar:hover {
    background: #26d0ce;
}

/* Sidebar */
.sidebar { width:220px; background:#2c3e50; color:white; position:fixed; top:70px; left:0; height:calc(100% - 70px); padding:20px; overflow-y:auto; transition: transform 0.3s ease; }
.sidebar.hidden { transform: translateX(-250px); }
.sidebar a { color:white; text-decoration:none; display:block; margin:12px 0; }
.sidebar a:hover { background:#34495e; padding-left:5px; }

/* Main content */
.main-content { margin-top:70px; margin-left:240px; padding:30px; padding-bottom:60px; }

/* Admin sections */
.admin-section { display:none; margin-top:20px; padding:10px; border:1px solid #ccc; background:#f8f8f8; border-radius:5px; }
.admin-section input, .admin-section select { width:70%; padding:8px; margin-right:5px; }
.admin-section button { padding:8px; margin-top:5px; cursor:pointer; }

/* User list */
#usersList div { margin:5px 0; padding:5px; background:#34495e; color:white; display:flex; justify-content:space-between; align-items:center; }
#usersList button { padding:3px 6px; cursor:pointer; }

/* Visits chart */
#visitsChart { width:100%; max-width:600px; height:300px; }

/* Footer */
footer { position: fixed; bottom:0; left:0; right:0; background: linear-gradient(90deg,#00F260,#0575E6); color:#fff; display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; font-weight:700; padding:6px 0; z-index:1000; }
footer .line2 { font-weight:600; font-size:13px; margin-top:2px; }
</style>
</head>
<body>

<header>
  <div>مرحبا، <span id="userName"></span></div>
  <nav><a href="#" id="logoutLink">تسجيل الخروج</a></nav>
</header>
  
<div id="toggleSidebar" style="
    position: fixed;
    top: 80px;       /* أعلى قليلاً تحت الهيدر */
    left: 0;
    width: 30px;
    height: 30px;
    background: #1a2980;
    color: white;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
    z-index: 1100;">
    &#9776;
</div>

<div class="sidebar">
  <a id="adminMenu" href="#">لوحة التحكم (Admin)</a>
  <a id="managePagesMenu" href="manage-pages.html">إدارة الخرائط</a>
</div>

<div class="main-content">
  <h2>لوحة التحكم</h2>

  <div id="adminAccounts" class="admin-section">
    <h3>إدارة الحسابات</h3>
    <input type="text" id="newUsername" placeholder="اسم المستخدم">
    <input type="password" id="newPassword" placeholder="كلمة المرور">
    <select id="newRole">
      <option value="admin">Admin</option>
      <option value="user">User</option>
      <option value="guest">Guest</option>
    </select>
    <button id="addUserBtn">إضافة مستخدم</button>
    <h4>المستخدمون الحاليون</h4>
    <div id="usersList"></div>
  </div>

  <div id="visitsControl" class="admin-section">
    <h3>زيارات المستخدمين</h3>
    <canvas id="visitsChart"></canvas>
  </div>
</div>

<footer>
  إعداد جهاز معلومات شبكات المرافق - محافظة الوادي الجديد
  <span class="line2">Designed By Eng. Ahmed Labib </span>
</footer>

<script>
window.onload = function() {
    // حماية الصفحة
    const sessionUser = protectPage(); // دالة من auth.js
    if(!sessionUser){
        alert("لم يتم التعرف على المستخدم، سيتم إعادة التوجيه");
        window.location.href = "index.html";
        return;
    }

    // عرض اسم المستخدم
    document.getElementById("userName").innerText = sessionUser.username;

    // عرض أقسام Admin فقط للمسؤول
    if(sessionUser.role==="admin"){
        ["adminAccounts","visitsControl"].forEach(id=>{
            const el = document.getElementById(id);
            if(el) el.style.display = "block";
        });
    }

    // Sidebar toggle
    const toggleBtn = document.getElementById("toggleSidebar");
    const sidebar = document.querySelector(".sidebar");
    toggleBtn.onclick = function() {
        sidebar.classList.toggle("hidden"); 
        toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;";
    };

    // ===== سجل زيارات المستخدمين =====
    const accountsKey = "users";
    if(!localStorage.getItem(accountsKey)){
        localStorage.setItem(accountsKey, JSON.stringify([
            { username: "admin", password: "1234", role: "admin" },
            { username: "user1", password: "1111", role: "user" },
            { username: "guest", password: "0000", role: "guest" }
        ]));
    }

    if(!localStorage.getItem("userVisits")){
        const allUsers = JSON.parse(localStorage.getItem(accountsKey));
        const visits = {};
        allUsers.forEach(u=>visits[u.username]=0);
        localStorage.setItem("userVisits", JSON.stringify(visits));
    }

    let visitsData = JSON.parse(localStorage.getItem("userVisits"));
    if(visitsData[sessionUser.username]!==undefined) visitsData[sessionUser.username]+=1;
    localStorage.setItem("userVisits", JSON.stringify(visitsData));

    // ===== شارت الزيارات =====
    const ctx = document.getElementById('visitsChart').getContext('2d');
    const visitsChart = new Chart(ctx, {
        type:'bar',
        data:{ labels:[], datasets:[{ label:'عدد الزيارات', data:[], backgroundColor:[] }] },
    });

    function updateVisitsChart(){
        const visits = JSON.parse(localStorage.getItem("userVisits"));
        visitsChart.data.labels = Object.keys(visits);
        visitsChart.data.datasets[0].data = Object.values(visits);
        visitsChart.data.datasets[0].backgroundColor = Object.keys(visits).map(u=>{
            if(u.toLowerCase()==='admin') return '#004b8d';
            if(u.toLowerCase()==='guest') return '#96c93d';
            return '#2c3e50';
        });
        visitsChart.update();
    }
    updateVisitsChart();

    // ===== إدارة الحسابات =====
    function loadUsers(){
        const userListDiv = document.getElementById("usersList");
        const allUsers = JSON.parse(localStorage.getItem(accountsKey));
        userListDiv.innerHTML = "";
        allUsers.forEach((u,index)=>{
            const div = document.createElement("div");
            div.innerHTML = `${u.username} (${u.role}) <span>`;
            if(sessionUser.role==="admin"){
                div.innerHTML += `<button onclick="deleteUser(${index})">حذف</button> <button onclick="changePassword(${index})">تغيير كلمة المرور</button>`;
            }
            div.innerHTML += `</span>`;
            userListDiv.appendChild(div);
        });
    }
    loadUsers();

    document.getElementById("addUserBtn").onclick = ()=>{
        const username = document.getElementById("newUsername").value.trim();
        const password = document.getElementById("newPassword").value;
        const role = document.getElementById("newRole").value;
        if(!username || !password){ alert("املأ جميع الحقول"); return; }
        const allUsers = JSON.parse(localStorage.getItem(accountsKey));
        if(allUsers.find(u=>u.username===username)){ alert("اسم المستخدم موجود"); return; }
        allUsers.push({username,password,role});
        localStorage.setItem(accountsKey,JSON.stringify(allUsers));
        let visits = JSON.parse(localStorage.getItem("userVisits"))||{};
        visits[username]=0;
        localStorage.setItem("userVisits", JSON.stringify(visits));
        updateVisitsChart();
        document.getElementById("newUsername").value="";
        document.getElementById("newPassword").value="";
        loadUsers(); updateVisitsChart();
    };

    window.deleteUser = function(index){
        if(!confirm("هل تريد حذف هذا المستخدم؟")) return;
        const allUsers = JSON.parse(localStorage.getItem(accountsKey));
        const username = allUsers[index].username;
        allUsers.splice(index,1);
        localStorage.setItem(accountsKey,JSON.stringify(allUsers));
        let visits = JSON.parse(localStorage.getItem("userVisits"));
        delete visits[username];
        localStorage.setItem("userVisits",JSON.stringify(visits));
        loadUsers(); updateVisitsChart();
    }

    window.changePassword = function(index){
        const allUsers = JSON.parse(localStorage.getItem(accountsKey));
        const newPass = prompt("ادخل كلمة المرور الجديدة:", allUsers[index].password);
        if(newPass){ allUsers[index].password=newPass; localStorage.setItem(accountsKey,JSON.stringify(allUsers)); loadUsers(); }
    }

    // ===== Sidebar dynamic maps =====
    function updateSidebarMaps() {
        document.querySelectorAll(".sidebar .dynamic-map").forEach(el => el.remove());
        const pages = JSON.parse(localStorage.getItem("pagesList") || "[]");
        pages.forEach((page,index)=>{
            if(page.roles && page.roles.includes("admin")){
                const a = document.createElement("a");
                a.href = page.url || "#";
                a.textContent = page.name || "خريطة";
                a.className = "dynamic-map";
                a.target = "_blank";
                if(!page.url) a.onclick = e => { e.preventDefault(); alert("لا يوجد رابط للخريطة"); };
                sidebar.appendChild(a);
            }
        });
    }
    updateSidebarMaps();

    // ===== تسجيل الخروج =====
    document.getElementById("logoutLink").onclick = ()=>{ logout(); };
};

</script>
</body>
</html>







