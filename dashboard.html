<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Ø¬Ù‡Ø§Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/auth.js"></script>

<style>
/* ---------------------------------
   CSS (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡)
   --------------------------------- */
body { margin:0; font-family:sans-serif; direction:rtl; }
/* Header */
header { background: linear-gradient(90deg,#00F260,#0575E6); color:white; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; position: fixed; top:0; left:0; right:0; z-index:1001; }
header span { font-weight:bold; }
header a { color:white; text-decoration:none; font-weight:bold; margin-left:15px; }

/* sidebar humbarger */
#toggleSidebar:hover {
Â  Â  background: #26d0ce;
}

/* Sidebar */
.sidebar { width:220px; background:#2c3e50; color:white; position:fixed; top:70px; left:0; height:calc(100% - 70px); padding:20px; overflow-y:auto; transition: transform 0.3s ease; }
.sidebar.hidden { transform: translateX(-250px); }
.sidebar a { color:white; text-decoration:none; display:block; margin:12px 0; padding: 5px; }
.sidebar a:hover { background:#34495e; padding-left:10px; }

/* Main content */
.main-content { margin-top:70px; margin-left:240px; padding:30px; padding-bottom:60px; }

/* Admin sections */
.admin-section { display:none; margin-top:20px; padding:10px; border:1px solid #ccc; background:#f8f8f8; border-radius:5px; }
.admin-section input, .admin-section select { width:70%; padding:8px; margin-right:5px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 5px;}
.admin-section button { padding:8px 15px; margin-top:5px; cursor:pointer; background: #004b8d; color: white; border: none; border-radius: 4px; }
.admin-section button:hover { opacity: 0.9; }

/* User list */
#usersList div { margin:8px 0; padding:10px; background:#e0e0e0; color:#333; display:flex; justify-content:space-between; align-items:center; border-radius: 4px; }
#usersList button { padding:5px 10px; cursor:pointer; background: #c0392b; color: white; border: none; }
#usersList button:hover { background: #e74c3c; }

/* Visits chart */
#visitsChart { width:100%; max-width:600px; height:300px; }

/* Footer */
footer { position: fixed; bottom:0; left:0; right:0; background: linear-gradient(90deg,#00F260,#0575E6); color:#fff; display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; font-weight:700; padding:6px 0; z-index:1000; }
footer .line2 { font-weight:600; font-size:13px; margin-top:2px; }
</style>
</head>
<body>

<header>
Â  <div>Ù…Ø±Ø­Ø¨Ø§ØŒ <span id="userName"></span></div>
Â  <nav><a href="#" id="logoutLink">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></nav>
</header>
Â Â 
<div id="toggleSidebar" style="
Â  Â  position: fixed;
Â  Â  top: 80px;Â  Â  Â  Â 
Â  Â  left: 0;
Â  Â  width: 30px;
Â  Â  height: 30px;
Â  Â  background: #1a2980;
Â  Â  color: white;
Â  Â  font-size: 24px;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  border-radius: 0 5px 5px 0;
Â  Â  cursor: pointer;
Â  Â  z-index: 1100;">
Â  Â  &#9776;
</div>

<div class="sidebar">
Â  <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h4>
Â  <a id="managePagesMenu" href="manage-pages.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø·</a>
Â  Â  <div id="dynamicMapsLinks"></div>
</div>

<div class="main-content">
Â  <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Admin)</h2>

Â  <div id="adminAccounts" class="admin-section">
Â  Â  <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
Â  Â  <input type="email" id="newUserEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)">
Â  Â  <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
Â  Â  <select id="newRole">
Â  Â  Â  <option value="admin">Admin</option>
Â  Â  Â  <option value="user">User</option>
Â  Â  Â  <option value="guest">Guest</option>
Â  Â  </select>
Â  Â  <button id="addUserBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
Â  Â  <h4>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h4>
Â  Â  <div id="usersList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>
Â  </div>

Â  <div id="visitsControl" class="admin-section">
Â  Â  <h3>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
Â  Â  <canvas id="visitsChart"></canvas>
Â  </div>
</div>

<footer>
Â  Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù‡Ø§Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ - Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
Â  <span class="line2">Designed By Eng. Ahmed Labib </span>
</footer>

<script>
    // ------------------ 1. ØªØ¹Ø±ÙŠÙ Chart.js ------------------
    let visitsChart;

    // ------------------ 2. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Øª Ù…Ù† Supabase ------------------
    async function updateVisitsChart(){
        const stats = await getVisitStats(); // Ø¯Ø§Ù„Ø© Ù…Ù† auth.js
        if (!stats) return;

        const roles = Object.keys(stats);
        const counts = Object.values(stats);

        if (!visitsChart) {
            const ctx = document.getElementById('visitsChart').getContext('2d');
            visitsChart = new Chart(ctx, {
                type:'bar',
                data:{
                    labels: roles,
                    datasets:[{
                        label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª',
                        data: counts,
                        backgroundColor: roles.map(r => {
                            if(r.toLowerCase()==='admin') return '#004b8d';
                            if(r.toLowerCase()==='guest') return '#96c93d';
                            return '#2c3e50';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        } else {
            visitsChart.data.labels = roles;
            visitsChart.data.datasets[0].data = counts;
            visitsChart.update();
        }
    }

    // ------------------ 3. Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ù€ Sidebar ------------------
    async function loadDynamicMaps(role) {
        const mapsContainer = document.getElementById("dynamicMapsLinks");
        mapsContainer.innerHTML = "";
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ù…Ù† auth.js Ù„Ø¯ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†
        const accessibleMaps = await getAccessibleMaps(role); 

        accessibleMaps.forEach(map => {
            const a = document.createElement("a");
            a.href = map.url;
            a.textContent = map.name;
            a.target = "_blank"; 
            mapsContainer.appendChild(a);
        });
    }

    // ------------------ 4. Ù…Ù†Ø·Ù‚ ØªØ­Ù…ÙŠÙ„ ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ------------------
    window.onload = async function() {
        
        // ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const userProfile = await protectPage(); // Ø¯Ø§Ù„Ø© Ù…Ù† auth.js
        
        if(!userProfile){
            window.location.href = "index.html";
            return;
        }

        // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ± (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Admin)
        if(userProfile.role !== "admin"){
            alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©ØŒ Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ.");
            if(userProfile.role === "user") window.location.href = "user.html";
            else if(userProfile.role === "guest") window.location.href = "guest.html";
            else logout();
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById("userName").innerText = userProfile.email;

        // Ø¹Ø±Ø¶ Ø£Ù‚Ø³Ø§Ù… Admin
        ["adminAccounts","visitsControl"].forEach(id=>{
            const el = document.getElementById(id);
            if(el) el.style.display = "block";
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¯Ø§Ù„Ø© Ù…Ù† auth.js)
        await loadUsersList(); 
        
        // ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø±Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
        await updateVisitsChart(); 
        
        // ØªØ­Ù…ÙŠÙ„ Ø®Ø±Ø§Ø¦Ø· Sidebar
        await loadDynamicMaps(userProfile.role);

        // Sidebar toggle
        const toggleBtn = document.getElementById("toggleSidebar");
        const sidebar = document.querySelector(".sidebar");
        toggleBtn.onclick = function() {
            sidebar.classList.toggle("hidden"); 
            toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;";
        };

        // ===== Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ =====
        document.getElementById("addUserBtn").onclick = async function() {
            const email = document.getElementById("newUserEmail").value.trim();
            const password = document.getElementById("newPassword").value;
            const role = document.getElementById("newRole").value;

            if(!email || !password){ alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }
            
            // ğŸ”‘ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© addUser Ù…Ù† auth.js
            const success = await addUser(email, password, role);

            if(success){
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!");
                document.getElementById("newUserEmail").value = "";
                document.getElementById("newPassword").value = "";
                await loadUsersList(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                await updateVisitsChart(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Øª
            }
        };

        // ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
        document.getElementById("logoutLink").onclick = (e) => { 
            e.preventDefault();
            logout(); 
        };
        
        // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ØªØ³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© deleteUser Ù…Ù† auth.js) =====
        // ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… (window.deleteUser) Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡Ø§ Ù…Ù† HTML ÙÙŠ Ø¯Ø§Ù„Ø© loadUsersList Ø¨Ù€ auth.js 
        // âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© deleteUser ÙÙŠ auth.js Ù„ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù€ index.
        window.deleteUser = async function(userId){
            if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            await deleteUser(userId);
            await loadUsersList(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            await updateVisitsChart(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Øª
        }
        
        // âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ù€ Front-end Ù…Ø¨Ø§Ø´Ø±Ø© ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Admin APIØŒ 
        // ÙˆÙ„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø³Ù†Ø²ÙŠÙ„ Ø²Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆÙ†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø­Ø°Ù.
    };
</script>
</body>
</html>
