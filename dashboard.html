<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - جهاز معلومات شبكات المرافق</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/auth.js"></script>
<style>
/* =============== الهيدر =============== */
body { margin:0; font-family:"Cairo",sans-serif; background:#f5f5f5; }
header {
  background: linear-gradient(90deg,#00F260,#0575E6);
  color:white; padding:15px 25px;
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
  position:fixed; top:0; left:0; right:0; z-index:1001;
}
header span { font-weight:bold; font-size:1rem; }
header nav a { color:white; text-decoration:none; font-weight:bold; margin-left:15px; }

/* =============== Sidebar =============== */
#toggleSidebar {
  position:fixed; top:80px; left:0; width:30px; height:30px;
  background:#1a2980; color:white; font-size:24px;
  display:flex; justify-content:center; align-items:center;
  border-radius:0 5px 5px 0; cursor:pointer; z-index:1100; transition:0.3s;
}
#toggleSidebar:hover { background:#26d0ce; }

.sidebar {
  width:220px; background:#2c3e50; color:white;
  position:fixed; top:70px; left:0; height:calc(100% - 70px);
  padding:20px; overflow-y:auto; transition:transform 0.3s ease;
}
.sidebar.hidden { transform:translateX(-250px); }
.sidebar a { color:white; text-decoration:none; display:block; margin:12px 0; padding:5px; transition:0.3s; border-radius:4px; }
.sidebar a:hover { background:#34495e; padding-left:10px; }

/* =============== Main Content =============== */
.main-content { margin-top:70px; margin-left:240px; padding:30px; padding-bottom:60px; transition:0.3s; }
.admin-section { margin-bottom:40px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

/* =============== Footer =============== */
footer { position:fixed; bottom:0; left:0; right:0;
  background:linear-gradient(90deg,#00F260,#0575E6);
  color:#fff; text-align:center; font-weight:700; padding:6px 0; z-index:1000;
}
footer .line2 { font-weight:600; font-size:13px; margin-top:2px; }

/* =============== Users Table =============== */
table { width:100%; border-collapse:collapse; margin-top:10px; }
table th, table td { padding:10px; text-align:right; border-bottom:1px solid #ccc; font-size:14px; }
table th { background:#00a86b; color:white; }
table tr:hover { background:#f2f2f2; }
button { padding:5px 10px; margin:2px; border:none; border-radius:4px; cursor:pointer; transition:0.3s; font-size:13px; }
button.save { background:#004b8d; color:white; }
button.delete { background:#e74c3c; color:white; }
button.save:hover { background:#002f5a; }
button.delete:hover { background:#c0392b; }

/* =============== Inputs =============== */
input, select { padding:6px; margin:2px; border:1px solid #ccc; border-radius:4px; }

/* =============== Chart =============== */
#visitsChart { height:200px !important; max-width:100%; }

/* =============== Responsive =============== */
@media (max-width:768px) {
  .main-content { margin-left:0; padding:15px; }
  .sidebar { width:200px; top:70px; height:calc(100%-70px); }
  #toggleSidebar { top:70px; }
}
@media (max-width:480px) {
  .sidebar { width:180px; padding:15px; }
  #toggleSidebar { width:28px; height:28px; font-size:20px; top:70px; }
}
</style>
</head>
<body>

<header>
  <nav><a href="#" id="logoutLink">تسجيل الخروج</a></nav>
  <div>مرحبا، <span id="userName"></span></div>
</header>

<div id="toggleSidebar">&#9776;</div>
<div class="sidebar">
  <h4>قائمة الأدمن</h4>
  <a href="manage-pages.html">إدارة الخرائط</a>
  <div id="dynamicMapsLinks"></div>
</div>

<div class="main-content">
  <h2>لوحة تحكم المسؤول</h2>

  <!-- إدارة المستخدمين -->
  <div id="adminAccounts" class="admin-section">
    <h3>إدارة الحسابات</h3>
    <div style="display:flex; flex-wrap:wrap; gap:5px;">
      <input type="text" id="newUserName" placeholder="اسم المستخدم">
      <input type="email" id="newUserEmail" placeholder="البريد الإلكتروني">
      <input type="password" id="newPassword" placeholder="كلمة المرور">
      <select id="newRole">
        <option value="admin">Admin</option>
        <option value="user">User</option>
        <option value="guest">Guest</option>
      </select>
      <button id="addUserBtn" class="save">إضافة مستخدم</button>
    </div>
    <div id="usersList" style="margin-top:10px;">جاري تحميل المستخدمين...</div>
  </div>

  <!-- شارت الزيارات -->
  <div id="visitsControl" class="admin-section">
    <h3>زيارات المستخدمين</h3>
    <canvas id="visitsChart"></canvas>
  </div>
</div>

<footer>
  إعداد جهاز معلومات شبكات المرافق - محافظة الوادي الجديد
  <span class="line2">Designed By Eng. Ahmed Labib</span>
</footer>

<script>
let visitsChart;
const apiBase = "/api";

// ===========================
// تحميل الصفحة وحماية الوصول
// ===========================
window.onload = async function(){
  const userProfile = await protectPage();
  if(!userProfile){ window.location.href="index.html"; return; }
  if(userProfile.role !== "admin"){ alert("ليس لديك صلاحية الوصول"); window.location.href="index.html"; return; }

  document.getElementById("userName").innerText = userProfile.name || userProfile.email;
  await loadUsersList();
  await updateVisitsChart();

  // Sidebar toggle
  const toggleBtn = document.getElementById("toggleSidebar");
  const sidebar = document.querySelector(".sidebar");
  toggleBtn.onclick = ()=>{ 
    sidebar.classList.toggle("hidden"); 
    toggleBtn.innerHTML = sidebar.classList.contains("hidden") ? "&#9776;" : "&times;"; 
  };

  // إضافة مستخدم جديد
  document.getElementById("addUserBtn").onclick = async function(){
    const name = document.getElementById("newUserName").value.trim();
    const email = document.getElementById("newUserEmail").value.trim();
    const password = document.getElementById("newPassword").value;
    const role = document.getElementById("newRole").value;
    if(!name || !email || !password){ alert("املأ جميع الحقول"); return; }

    const success = await addUser(name,email,password,role);
    if(success){ alert("تم إضافة المستخدم"); loadUsersList(); }
  };

  document.getElementById("logoutLink").onclick = e=>{ e.preventDefault(); logout(); };
};

// ===========================
// إدارة المستخدمين
// ===========================
async function loadUsersList(){
  const container = document.getElementById("usersList");
  container.innerHTML = "جاري التحميل...";
  const users = await getUsers();
  if(!users || users.length===0){ container.innerHTML="لا يوجد مستخدمين"; return; }

  let html = `<table>
    <thead><tr><th>الاسم</th><th>البريد</th><th>الدور</th><th>إجراء</th></tr></thead><tbody>`;
  users.forEach(u=>{
    html+=`<tr>
      <td>${u.name}</td>
      <td>${u.username || u.email}</td>
      <td>
        <select onchange="updateUserRole('${u.id}',this.value)">
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
          <option value="user" ${u.role==='user'?'selected':''}>User</option>
          <option value="guest" ${u.role==='guest'?'selected':''}>Guest</option>
        </select>
      </td>
      <td>
        <button class="save" onclick="updateUser('${u.id}')">حفظ</button>
        <button class="delete" onclick="deleteUser('${u.id}')">حذف</button>
      </td>
    </tr>`;
  });
  html+="</tbody></table>";
  container.innerHTML = html;
}

async function updateUser(id){
  const pwd = prompt("أدخل كلمة السر الجديدة:");
  if(!pwd) return;
  const success = await updateUserPassword(id,pwd); // دالة موجودة في auth.js
  if(success) alert("تم تحديث كلمة المرور");
}
async function deleteUser(id){
  if(!confirm("هل تريد حذف المستخدم؟")) return;
  const success = await deleteUser(id);
  if(success) loadUsersList();
}

// ===========================
// شارت الزيارات
// ===========================
async function updateVisitsChart(){
  const stats = await getVisitStats(); 
  if(!stats) return;

  const labels = [];
  const data = [];
  const lastVisits = [];
  Object.keys(stats).forEach(role=>{
    labels.push(role);
    data.push(stats[role].count || stats[role]);
    lastVisits.push(stats[role].lastVisit || '-');
  });

  const ctx = document.getElementById('visitsChart').getContext('2d');
  if(visitsChart) visitsChart.destroy();

  visitsChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels,
      datasets:[{ label:'عدد الزيارات', data, backgroundColor:'#004b8d' }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        tooltip:{
          callbacks:{
            label: ctx=>`عدد الزيارات: ${ctx.raw}`,
            afterLabel: ctx=>{
              const role = ctx.label;
              return `آخر زيارة: ${lastVisits[ctx.dataIndex]}`;
            }
          }
        }
      },
      scales:{ y:{ beginAtZero:true } }
    }
  });
}
</script>

</body>
</html>
